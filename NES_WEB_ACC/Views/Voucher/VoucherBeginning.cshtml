@model NES_WEB_ACC.ViewModels.CreateInfoViewModel
@{
    ViewBag.Title = @Resources.Content.VoucherBeginning;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section css {
    <link rel="stylesheet" type="text/css" href="~/Scripts/mycss/body_container_erp.css" />
    <style>
        /*#region Body style*/

        #content-tabs {
            padding-bottom: 10px;
        }

        /*#endregion*/

        /*#region easyui style*/
        .textbox-readonly .textbox-text {
            background: #EEEEEE;
        }

        .ischecked-row:not(.datagrid-row-over,.datagrid-row-checked,.datagrid-row-selected) {
            background-color: #fdff47;
            color: black;
            cursor: default;
        }

        /*.yellow-row:not(.datagrid-row-over,.datagrid-row-checked,.datagrid-row-selected) {
            background-color: #a2f8f8;
            color: black;
            cursor: default;
        }*/

        .gray-row:not(.datagrid-row-over,.datagrid-row-checked,.datagrid-row-selected) {
            background-color: #fa806f;
            color: black;
            cursor: default;
        }

        .close-row:not(.datagrid-row-over,.datagrid-row-checked,.datagrid-row-selected) {
            background-color: #6df757;
            color: black;
            cursor: default;
        }

        .cancel-row:not(.datagrid-row-over,.datagrid-row-checked,.datagrid-row-selected) {
            background-color: #e196fb;
            color: black;
            cursor: default;
        }

        .error-row:not(.datagrid-row-over,.datagrid-row-checked,.datagrid-row-selected) {
            background-color: #fdff47;
            color: black;
            cursor: default;
        }

        .datagrid-row-selected div {
            color: white;
        }

        .datagrid-row-selected {
            background-color: #3399ff !important;
        }

        .datagrid-row-editing td {
            color: black;
        }

        .header-toolbar .easyui-linkbutton {
            width: 50px;
            height: 52px;
            font-size: 0.9em;
            font-weight: bold;
            margin: 0px;
            padding: 0px;
        }

        .header-toolbar .linkbtn2 {
            width: 60px;
        }

        .header-toolbar .linkbtn3 {
            width: 95px;
        }

        .header-toolbar .l-btn-text {
            font-size: 12px !important;
            margin-top: 28px !important;
        }

        .header-toolbar .l-btn-icon {
            width: 24px !important;
            height: 24px !important;
            left: 60% !important;
        }

        .separatorbar {
            margin-right: 20px;
        }

        .tabs-wrap .tabs {
            width: 99% !important;
        }

        .switchbtn {
            text-decoration: none;
            display: inline-block;
            overflow: hidden;
            vertical-align: middle;
            margin: 5px 10px 0px 0px;
            padding: 3px;
            cursor: pointer;
            border: 1px solid #bbb;
            -moz-border-radius: 5px 5px 5px 5px;
            -webkit-border-radius: 5px 5px 5px 5px;
            border-radius: 5px 5px 5px 5px;
        }

            .switchbtn label {
                margin-left: 3px;
            }

        .btnliktype .l-btn-text {
            margin-left: 15px;
            font-size: 12px !important;
        }
        /*#endregion*/
        /*#region datagrid style*/

        .datagrid-view tr, .datagrid-view td {
            border: 1px solid black;
        }

        .datagrid-header-row td {
            background-color: #d2d2d2;
            color: #333;
            font-weight: bold;
            border: 1px solid black !important;
        }

        .datagrid-header, .datagrid-td-rownumber {
            background-color: #fff !important;
            background: none;
            background-repeat: no-repeat;
        }


        .datagrid-cell-rownumber {
            color: black !important;
        }

        .datagrid-row .datagrid-cell {
            margin: 0px !important;
            padding: 0px;
        }

        .subtd {
            width: 100% !important;
            height: 100% !important;
            margin: 0px !important;
            padding: 1px !important;
            border: 1px solid black !important;
            min-height: 22px;
        }
        /*#endregion */
        /*#region table style*/
        /* 初始表格外框顏色 */
        .datagrid {
            border: 2px solid white; /* 默認顏色 */
        }

        .container-table {
            width: 99%;
            margin: 0px 20px 0px 2px;
            padding: 0px;
            table-layout: fixed;
            word-break: break-all;
        }

            .container-table .table-header {
                background-color: #95B3D7;
                border: solid 1px black;
            }

            .container-table th, .container-table tr, .container-table tr td {
                /*border: none;*/
                border: solid 1px black !important;
                text-align: center;
            }

            .container-table th, .container-table tr, .container-table td {
                height: 32px !important;
                margin: 0px !important;
                padding: 0px !important;
            }

                .container-table tr td {
                    font-size: 1.0em;
                    vertical-align: middle !important;
                    font-weight: bold;
                }

            .container-table th {
                font-size: 1.0em;
                vertical-align: middle !important;
            }

        tr td label {
            margin: 0px !important;
            padding: 0px !important;
        }
        /*#endregion*/
        /*#region row style*/
        .row-fix {
            margin-left: 0px !important;
        }

        .row-filestyle {
            margin-top: 5px;
            margin-left: 3px;
            margin-bottom: 5px;
            border-bottom: 1px solid black;
            padding: 3px;
        }

        .col-fix-1, .col-fix-2, .col-fix-3 {
            padding: 0px;
            margin-right: 0px;
        }

            .col-fix-1 > span {
                margin-left: 35px;
            }

            .col-fix-1 input[type="text"], .col-fix-1 .form-control,
            .col-fix-1 .easyui-combobox,
            .col-fix-1 .easyui-textbox:not(.col-fix-lg),
            .col-fix-1 .easyui-datebox, .col-fix-1 .easyui-maskedbox {
                width: 120px !important;
            }


            .col-fix-2 input[type="text"]:not(.textbox-text), .col-fix-2 .form-control,
            .col-fix-2 .easyui-combobox, .col-fix-2 .easyui-textbox,
            .col-fix-2 .easyui-datebox, .col-fix-2 .easyui-maskedbox {
                width: 110px !important;
            }

            .col-fix-3 input[type="text"], .col-fix-3 .form-control,
            .col-fix-3 .easyui-combobox, .col-fix-3 .easyui-textbox,
            .col-fix-3 .easyui-datebox, .col-fix-3 .easyui-maskedbox {
                width: 120px !important;
            }

            .col-fix-1 .col-fix-lg, .col-fix-2 .col-fix-lg, .col-fix-3 .col-fix-lg {
                width: 300px !important;
            }

                .col-fix-1 .col-fix-lg input[type="text"], .col-fix-1 .col-fix-lg .easyui-textbox {
                    width: 300px !important;
                }
        /*#endregion*/


        .progress-extended div label, .progress-txtextended div label {
            width: 100%;
            text-align: left;
        }

        .progress-extended .row, .progress-txtextended .row {
            margin: 10px;
            padding: 5px;
            border-bottom: 0.5px solid black;
        }

            .progress-extended .row .btn, .progress-txtextended .row .btn {
                margin-right: 15px;
            }

        .form-viewer {
            width: 99%;
            height: 100%;
        }

        /*#region form style*/
        .formtext {
            white-space: nowrap;
            border: 1px solid black;
        }

        .formimport {
            border: 1px solid black;
        }
        /*#endregion */
        @@media (max-width: 1400px) {
            #submenu {
                font-size: 0.9em !important;
            }

            #body-container {
                max-height: calc(100vh - 130px);
                font-size: 0.9em;
            }

            #content-top {
                font-size: 0.9em !important;
                min-height: 155px;
            }

            #content-grid {
                min-height: calc(100vh - 300px);
            }

            .panel-title, .tabs-title {
                font-size: 0.8em;
            }

            .panel-header, .tabs, .tabs-wrap, .tabs-selected, .tabs-inner {
                height: 23px !important;
                padding: 1px !important;
            }

            .datagrid-cell {
                font-size: 0.8em !important;
            }

            .datagrid-header-row {
                font-size: 0.8em !important;
                height: 28px !important;
            }

            .layout-panel-center .datagrid-row,
            .layout-panel-center .datagrid-row-editing,
            .layout-panel-center .datagrid-row-editing td,
            .layout-panel-center .datagrid-row-editing span,
            .layout-panel-center .datagrid-row-editing input {
                height: 35px;
            }

            .col-fix-1 label, .col-fix-2 label, .col-fix-3 label {
                font-size: 9px !important;
            }

            .col-fix-1 span {
                margin-left: 10px;
            }

            .col-fix-1 input[type="text"], .col-fix-1 .form-control,
            .col-fix-1 .easyui-combobox, .col-fix-1 .easyui-textbox,
            .col-fix-1 .easyui-datebox, .col-fix-1 .easyui-maskedbox {
                font-size: 9px !important;
                width: 100px !important;
            }

            .col-fix-2 input[type="text"], .col-fix-2 .form-control,
            .col-fix-2 .easyui-combobox, .col-fix-2 .easyui-textbox,
            .col-fix-2 .easyui-datebox, .col-fix-2 .easyui-maskedbox {
                font-size: 9px !important;
                width: 90px !important;
            }

            .col-fix-3 input[type="text"], .col-fix-3 .form-control,
            .col-fix-3 .easyui-combobox, .col-fix-3 .easyui-textbox,
            .col-fix-3 .easyui-datebox, .col-fix-3 .easyui-maskedbox {
                font-size: 9px !important;
                width: 100px !important;
            }

            .col-fix-4 input[type="text"], .col-fix-4 .form-control,
            .col-fix-4 .easyui-combobox, .col-fix-4 .easyui-textbox,
            .col-fix-4 .easyui-datebox, .col-fix-4 .easyui-maskedbox {
                font-size: 9px !important;
                width: 80px !important;
            }

            .col-fix-1 .col-fix-lg, .col-fix-2 .col-fix-lg, .col-fix-3 .col-fix-lg {
                width: 200px !important;
            }

            .textbox-button .l-btn-left {
                margin: 0px !important;
                padding-left: 20px;
                height: 28px;
                width: 28px;
            }

                .textbox-button .l-btn-left .l-btn-icon {
                    margin-top: -8px;
                    margin-left: 0px !important;
                }

            .textbox-button .l-btn-text {
                font-size: 0px !important;
            }

            .btndeliverychange, .btnmanualclose, .btnstockenter {
                width: 65px !important;
                height: 45px !important;
            }

            .btnreportset {
                width: 60px !important;
                height: 45px !important;
                font-size: 0.7em !important;
            }
        }
    </style>
}

@{ Html.RenderAction("_ToolBarPartial"); }
<div id="body-container">
    <div class="easyui-layout body-layout">
        <div data-options="region:'west',collapsible:false" title="" style="width:25%;height:100%;">
            <table id="maindg" class="datagrid easyui-maindg" style="width:100%;height:100%;"></table>
        </div>

        <div data-options="region:'east',collapsible:false" title="" style="width: 75%; height: 100%;">
            <div class="row" style="width: 99%;height:21%; margin: 2px;">
                @{ Html.RenderAction("_VoucherTableInfoPartial"); }
            </div>
            <div class="row" style="width: 99%; height: 70%; margin: 2px;">
                <div id="content-tabs" class="easyui-tabs" style="width:100%;height:100%;">
                    <div title="分錄明細" style="padding:2px;display:none;">
                        <table id="itemdg" class="datagrid easyui-itemdg" style="width: 100%; height: 100%; margin: 5px;"></table>
                    </div>
                    <div title="進階資料" style="overflow: auto; padding: 20px; display: none;">
                        @{ Html.RenderAction("_VoucherTableAdvPartial"); }
                    </div>
                </div>
            </div>
            <div class="row" style="width: 99%; height: 5%; margin: 0px;">
                @{ Html.RenderAction("_VoucherDCShowPartial"); }
            </div>
        </div>
    </div>
</div>
@*dialog_[編輯]科目編號_dlgdg1*@
<div id="dlgEditAccNo" class="easyui-dialog" data-options="modal:true,closed:true">
    <div id="toolbar1">
        @*<a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg1search')">Search</a>*@
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg1insert')">選入</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg1exit')">離開</a>
    </div>
    <table id="dlgdg1" class="datagrid easyui-maindg" style="width:100%;height:100%;"></table>
</div>
@*dialog_[編輯]對象編號_dlgdg3*@
<div id="dlgEditTargetNo" class="easyui-dialog" data-options="modal:true,closed:true">

    <div id="dlgtabs" class="easyui-tabs" style="width:100%;height:100%;">
        <div title="廠商">
            <div id="toolbar30">
                <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg30insert')">選入</a>
                <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg3exit')">離開</a>
            </div>
            <table id="dlgdg30" class="datagrid easyui-itemdg" style="width:100%;height:100%;"></table>
        </div>
        <div title="客戶">
            <div id="toolbar31">
                <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg31insert')">選入</a>
                <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg3exit')">離開</a>
            </div>
            <table id="dlgdg31" class="datagrid easyui-itemdg" style="width:100%;height:100%;"></table>
        </div>
        <div title="員工">
            <div id="toolbar32">
                <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg32insert')">選入</a>
                <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg3exit')">離開</a>
            </div>
            <table id="dlgdg32" class="datagrid easyui-itemdg" style="width:100%;height:100%;"></table>
        </div>
        <div title="銀行">
            <div id="toolbar33">
                <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg33insert')">選入</a>
                <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg3exit')">離開</a>
            </div>
            <table id="dlgdg33" class="datagrid easyui-itemdg" style="width:100%;height:100%;"></table>
        </div>
    </div>
</div>
@*dialog_[編輯]成本中心編號_dlgdg4*@
<div id="dlgEditAccDept" class="easyui-dialog" data-options="modal:true,closed:true">
    <div id="toolbar4">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg4insert')">選入</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg4exit')">離開</a>
    </div>
    <table id="dlgdg4" class="datagrid easyui-itemdg" style="width:100%;height:100%;"></table>
</div>
@*dialog_[編輯]支付部門編號_dlgdg5*@
<div id="dlgEditPayDept" class="easyui-dialog" data-options="modal:true,closed:true">
    <div id="toolbar5">
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg5insert')">選入</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="btnClick('dlgdg5exit')">離開</a>
    </div>
    <table id="dlgdg5" class="datagrid easyui-itemdg" style="width:100%;height:100%;"></table>
</div>
@*右鍵顯示div*@
<div id="mm" class="easyui-menu" data-options="onClick:menuHandler" style="width:130px;">
    <div data-options="name:'addF',iconCls:'icon-add'">@Resources.Content.AddPrevious</div>
    <div data-options="name:'addB',iconCls:'icon-add'">@Resources.Content.AddNext</div>
    <div data-options="name:'remove',iconCls:'icon-remove'">@Resources.Content.Remove</div>
    @*<div class="menu-sep"></div>
        <div data-options="name:'addD'">新增_借</div>
        <div data-options="name:'addC'">新增_貸</div>*@
    <div class="menu-sep"></div>
    <div data-options="name:'adds',iconCls:'icon-reload'">新增...</div>
</div>

@section Scripts {
    <script src="~/Scripts/easyui/jquery.edatagrid.js"></script>
    <script src="~/Scripts/easyui/datagrid-filter.js"></script>
    <script src="~/Scripts/myjs/myMath.js"></script>
    <script>
        ///-----基本參數-----///
        //#region 基本參數
        var controllerurl = '/Voucher', functionurl = "/", actionurl = "";
        var maindg = $('#maindg'),        //左側列表
            itemdg = $('#itemdg');      //表身頁籤1列表
        var dlgdg1 = $('#dlgdg1'),        //Dlg列表-會計科目
            dlgdg2 = $('#dlgdg2'),        //Dlg列表-交易幣別
            dlgdg30 = $('#dlgdg30'), dlgdg31 = $('#dlgdg31'), dlgdg32 = $('#dlgdg32'), dlgdg33 = $('#dlgdg33')        //Dlg列表-對象編號
            dlgdg4 = $('#dlgdg4'),        //Dlg列表-成本中心
            dlgdg5 = $('#dlgdg5');        //Dlg列表-支付部門
        var infotabs = $('#infotabs'),  //右側表頭頁籤
            itmetabs = $('#content-tabs'),//右側表身頁籤
            advtabs = $('#advtabs'), //右側表身頁籤3_進階資料
            dlgtabs = $('#dlgtabs');
        var maindgIndex = -1, fitemdgIndex,
            itemdgIndex;

        var actioncode = 'view';

        //#endregion
        //#region 多語系
        var maindglang = {
            BillDate: '@Resources.Content.BillDate',
            BillNo: '@Resources.Content.BillNo',
            VoucherNameC: '@Resources.Content.VoucherNameC',
            EmpNo: '@Resources.Content.EmpNo',
            EmpNameC: '@Resources.Content.EmpNameC',
            Remark: '@Resources.Content.Remark',
            CompNo: '@Resources.Content.CompNo',
            CompAbbr: '@Resources.Content.CompAbbr'
        };
        var itemdglang = {
            Linage:'@Resources.Content.Linage',
            AccNo: '@Resources.Content.AccNo',
            AccName:'@Resources.Content.AccName',
            Remark: '@Resources.Content.Remark',
            DCTypeNo: '@Resources.Content.DCTypeNo',
            CurrencyNo: '@Resources.Content.CurrencyNo',
            CurrencySt: '@Resources.Content.CurrencySt',
            Rate: '@Resources.Content.Rate',
            Aamount:'@Resources.Content.Aamount',
            Tamount: '@Resources.Content.Tamount',
            TargetType: '@Resources.Content.TargetType',
            TargetNo: '@Resources.Content.TargetType',
            TargetAbbr: '@Resources.Content.TargetType',
            AccProfitNo: '@Resources.Content.AccProfitNo',
            AccProfitName: '@Resources.Content.AccProfitName',
            AccDeptNo: '@Resources.Content.AccDeptNo',
            AccDeptName: '@Resources.Content.AccDeptName',
            PayDeptNo: '@Resources.Content.PayDeptNo',
            PayDeptName: '@Resources.Content.PayDeptName',
            CheckNo: '@Resources.Content.CheckNo',
            OffsetNo: '@Resources.Content.OffsetNo',
            CaseBillNo: '@Resources.Content.CaseBillNo',
            SourceDocSubTypeName: '@Resources.Content.SourceDocSubTypeName',
            SourceNo: '@Resources.Content.SourceNo',
            InitialDocSubTypeName: '@Resources.Content.InitialDocSubTypeName',
            InitialNo: '@Resources.Content.InitialNo',
            ActivityType: '@Resources.Content.ActivityType',
        };
        var msglang = {
            Title1: '@Resources.Content.Confirm', // 確認
            Title2: '@Resources.Content.Alert',  // 警告
            Title3: '@Resources.Content.Prompts',  // 提示
            MsgCfmLeave: '@Resources.Content.MsgCfmLeave',//是否要離開?
            MsgCfmCancel: '@Resources.Content.MsgCfmLeave',//是否要取消?
            MsgCfmSend: '@Resources.Content.MsgCfmSend',//是否要送出?
            MsgErrCode: '@Resources.Content.MsgErrCode',//後端回傳錯誤
            MsgErrAja: '@Resources.Content.MsgErrAja', //伺服器錯誤
            MsgErrDc: '@Resources.Content.MsgErrDc', //借貸不平衡
            MsgErrSaveFirst: '@Resources.Content.MsgErrSaveFirst', //請先儲存
            MsgSelectRow: '@Resources.Content.MsgSelectRow',//選擇行編輯
            MsgSelectRow1: '@Resources.Content.MsgSelectRow1',//選擇行刪除
            MsgSelectRow2: '@Resources.Content.MsgSelectRow2',//選擇行送出
            MsgSelectRow3: '@Resources.Content.MsgSelectRow3',//選擇行填入
            MsgActionErr: '@Resources.Content.MsgActionErr', //操作碼錯誤
            MsgSes1: '@Resources.Content.MsgSes1', //成功新增
            MsgSes2: '@Resources.Content.MsgSes2', //成功編輯
            MsgSes3: '@Resources.Content.MsgSes3', //成功啟用
            MsgSes4: '@Resources.Content.MsgSes4', //成功停用
            MsgSes5: '@Resources.Content.MsgSes5', //成功送審
            MsgSes6: '@Resources.Content.MsgSes6', //成功退件
            MsgSes7: '@Resources.Content.MsgSes7', //成功結案
            MsgSes8: '@Resources.Content.MsgSes8', //成功刪除
        };
        //#endregion
        //#region 資料暫存
        var objAccNo = { name: 'AccNo', data: null };
        var objCurrencyNo = { name: 'CurrencyNo', data: @Html.Raw(Json.Encode(ViewData["CurrencyNo"])) };
        var objAccDept = { name: 'AccDept', data: null };
        var objTargetNo0 = { name: 'TargetNo0', data: null };
        var objTargetNo1 = { name: 'TargetNo1', data: null };
        var objTargetNo2 = { name: 'TargetNo2', data: null };
        var objTargetNo3 = { name: 'TargetNo3', data: null };
        var objPayDept = { name: 'PayDept', data: null };
        var objTargetType = { name: 'TargetType', data: null };
        //#endregion

        //#region 初始化
        $(function () {
            ///-----dg欄位設定-----///
            maindgSet();    //左側列表欄位
            itemdgSet();    //右側側列表欄位_分錄明細
            dlgdg1Set();    //編輯_科目編號
            dlgdg2Set();    //編輯_幣別
            dlgdg3Set();    //編輯_目標編號
            dlgdg4Set();    //編輯_成本中心
            dlgdg5Set();    //編輯_支付部門
            ///-----按鈕狀態-----///
            btnEnableSet('view');
            ///-----資料填值-----///
            maindgData();
            ///-----其他設定-----///
            $('#myDatebox').myDatebox({
                culture: '@ViewBag.CurrentCulture' // 傳遞語言參數
            });
        });

        //#endregion

        //#region dg設定與填值
        ///----- 頁面dg -----///
        function maindgSet() {
            maindg.datagrid({
                singleSelect: true,
                striped: true,
                columns: [[
                    { field: 'WebId', title: 'WebId', hidden: true, type: 'text' },
                    { field: 'Id', title: 'Id', hidden: true, type: 'text' },
                    { field: 'Flag', title: '旗', hidden: true },
                    { field: 'BillDate', title: maindglang.BillDate, width: 80, editor: { type: 'text' }, styler: function (value, row, index) { return 'border:1px solid black;' } },
                    { field: 'BillNo', title: maindglang.BillNo, width: 130, editor: { type: 'text' }, styler: function (value, row, index) { return 'border:1px solid black;' } },
                    { field: 'VoucherNameC', title: maindglang.VoucherNameC, hidden: true },
                    { field: 'EmpNo', title: maindglang.EmpNo, width: 150, editor: { type: 'text' }, styler: function (value, row, index) { return 'border:1px solid black;' } },
                    { field: 'EmpNameC', title: maindglang.EmpNameC, width: 150, editor: { type: 'text' }, styler: function (value, row, index) { return 'border:1px solid black;' } },
                    { field: 'Remark', title: maindglang.Remark, width: 150, editor: { type: 'text' }, styler: function (value, row, index) { return 'border:1px solid black;' } },
                    { field: 'CompNo', title: maindglang.CompNo, width: 150, editor: { type: 'text' }, styler: function (value, row, index) { return 'border:1px solid black;' } },
                    { field: 'CompAbbr', title: maindglang.CompAbbr, width: 150, editor: { type: 'text' }, styler: function (value, row, index) { return 'border:1px solid black;' } },
                    { field: 'BillStatus', title: 'BillStatus', hidden: true  }
                ]],
                onSelect: function (index, row) {
                    if (row.BillStatus == '1' || row.BillStatus == '2') {
                        $('#btnEdit').linkbutton('disable');
                        $('#btnLock').linkbutton('disable');
                    } else {
                        $('#btnEdit').linkbutton('enable');
                        $('#btnLock').linkbutton('enable');
                        if (actioncode === 'add' || actioncode === 'edit') {
                            if (maindgIndex !== index) {
                                $.messager.confirm(msglang.Title1, msglang.MsgCfmLeave, function (r) {
                                    if (r) {
                                        infotabs.tabs('select', 0); //表頭表單切換
                                        advtabs.tabs('select', 0); //進階資訊切換
                                        maindgIndex = index; // 更新目前行索引
                                        actioncode = 'view'; // 更新行為模式
                                        btnEnableSet(actioncode); // 更新按鈕狀態
                                        tableHeadData(row); // 更新表頭資料
                                        itemdgData(row.WebId); // 更新相關資料表
                                        maindg.datagrid('selectRow', index); // 選擇新行
                                    } else {
                                        maindg.datagrid('unselectRow', index);
                                        maindg.datagrid('selectRow', maindgIndex); // 重新選擇原來的行
                                    }
                                });
                            }
                        } else {
                            maindgIndex = index;
                            tableHeadData(row);
                            itemdgData(row.WebId);
                        }
                    }
                },
                rowStyler: function (index, row) {
                    if (row.BillStatus == '0') { //新建立
                        return 'background-color:#FFFFFF;color:#000000;';
                    }
                    if (row.BillStatus == '1') { //已覆核
                        return 'background-color:#E4CE40;color:#000000;';
                    }
                    if (row.BillStatus == '2') { //主管已審核
                        return 'background-color:#A7CECB;color:#000000;';
                    }
                    if (row.BillStatus == '3') { //已結案
                        return 'background-color:#C0C0C0;color:#000000;';
                    }
                    if (row.BillStatus == '4') { //主管退件
                        return 'background-color:#FF8552;color:#000000;';
                    }
                    if (row.BillStatus == '5') { //結案退件
                        return 'background-color:#FF52F4;color:#000000;';
                    }

                }
            });
        }
        function maindgData() {
            actionurl = defaultUrl + controllerurl + functionurl + 'GetVoucherInfo?type=begin';
            doajax("GET", actionurl, null, function (result) {
                if (result.success) {
                    if (Array.isArray(result.data)) {
                        // 遍歷數據並格式化日期
                        result.data.forEach(function (item) {
                            if (item.BillDate) {
                                item.BillDate = formatDate(item.BillDate); // 使用formatDate函數格式化日期
                            }
                        });
                    }
                    maindg.datagrid('loadData', result.data);
                    let billno = '@ViewBag.BillNo';
                    if (billno) {
                        selectRow(billno);
                    }
                } else {
                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                    if (result.code == 'C0004') {
                        console.log(result.err);
                    }
                    //maindg.datagrid('loadData', '');
                }
            });
        }
        function itemdgSet() {
            itemdg.datagrid({
                singleSelect: true,
                striped: true,
                fitColumns: true,
                columns: [[
                    { field: 'WebId', title: 'WebId', hidden: true, type: 'text' },
                    { field: 'Id', title: 'Id', hidden: true, type: 'text' },
                    { field: 'Linage', title: itemdglang.Linage, align: 'center', hidden: false, type: 'string' },
                    {
                        field: 'AccNo', title: itemdglang.AccNo, width: '10%', hidden: false, type: 'string',
                        editor: {
                            type: 'textbox',
                            options: {
                                icons: [{
                                    iconCls: 'icon-search',
                                    handler: function (e) {
                                        dlgEditAccNo();
                                    }
                                }]
                            }
                        }
                    },
                    { field: 'AccName', title: itemdglang.AccName, width: '20%', hidden: false, type: 'string' },
                    {
                        field: 'Remark', title: itemdglang.Remark, width: '20%', type: 'string',
                        editor: {
                            type: 'textbox'
                        }
                    },
                    {
                        field: 'DCTypeNo', title: itemdglang.DCTypeNo, align: 'center', hidden: false, type: 'string',
                        editor: {
                            type: 'combobox',
                            options: {
                                valueField: 'value',       // 對應的值字段
                                textField: 'label',        // 顯示的文本字段
                                data: [
                                    { label: 'D', value: 'D' },
                                    { label: 'C', value: 'C' }
                                ],
                                panelHeight: 'auto'
                            }
                        }
                    },
                    { field: 'DCTypeNameC', title: '借貸名稱', width: '8%', hidden: true, type: 'string' },
                    {
                        field: 'CurrencyNo', title: itemdglang.CurrencyNo, width: '8%', align: 'center', hidden: false, type: 'string',
                        editor: {
                            type: 'combobox',
                            options: {
                                valueField: 'CurrencyNo',
                                textField: 'CurrencyNo',
                                panelHeight: 'auto',
                                editable: false,
                                required: true,
                                data: objCurrencyNo.data,
                                onChange: function (newValue, oldValue) {
                                    updateRate('0', newValue);
                                }
                            }
                        }
                    },
                    {
                        field: 'Money', title: itemdglang.Tamount, width: '8%', align: 'right', hidden: false, type: 'number',
                        editor: {
                            type: 'numberbox',
                            options: {
                                precision: 3,  // 保留小數點後兩位
                                min: 0,        // 最小值設置為 0 或其他合適的值
                                decimalSeparator: '.', // 設置小數點分隔符
                                onChange: function (newValue, oldValue) {
                                    updateMoney1('0',newValue);
                                }
                            }
                        },
                        formatter: function (value, row, index) {
                            return parseFloat(value).toFixed(3);
                        }
                    },
                    {
                        field: 'Rate1', title: itemdglang.Rate, width: '5%', align: 'center', hidden: false, type: 'number',
                        editor: {
                            type: 'numberbox',
                            options: {
                                precision: 3,
                                min: 0,
                                //groupSeparator: ',',  // 設置數字分隔符
                                decimalSeparator: '.', // 設置小數點分隔符
                                onChange: function (newValue, oldValue) {
                                    updateMoney1('1',newValue);
                                }
                            }
                        },
                        formatter: function (value, row, index) {
                            return parseFloat(value).toFixed(3);
                        }
                    },
                    { field: 'CurrencySt', title: itemdglang.CurrencySt, width: '8%', align: 'center', type: 'string'},
                    {
                        field: 'Money1', title: itemdglang.Aamount, width: '8%', align: 'right', hidden: false, type: 'number',
                        editor: {
                            type: 'numberbox',
                            options: {
                                precision: 3,  // 保留小數點後兩位
                                min: 0,        // 最小值設置為 0 或其他合適的值
                                //groupSeparator: ',',  // 設置數字分隔符
                                decimalSeparator: '.', // 設置小數點分隔符
                                onChange: function (newValue, oldValue) {
                                    updateRate('1', newValue);
                                }
                            }
                        },
                        formatter: function (value, row, index) {
                            return parseFloat(value).toFixed(3);
                        }
                    },
                    { field: 'TargetId', title: '對象別Id', width: '10%', hidden: true, type: 'string', },
                    {
                        field: 'TargetType', title: itemdglang.TargetType, width: '5%', hidden: false, type: 'string', formatter: formatTargetType,
                        editor: {
                            type: 'combogrid',
                            options: {
                                panelWidth: 200,  // 可以根據需要調整寬度
                                idField: 'TargetType',
                                textField: 'TargetTypeName',
                                mode: 'remote',
                                loader: function (param, success, error) {
                                    objdata({ name: 'TargetType' }, 'read', function (objtype) {
                                        if (objtype.data) {
                                            success(objtype.data);
                                        }
                                    });
                                },
                                columns: [[
                                    { field: 'TargetType', title: '編號', width: 97 },
                                    { field: 'TargetTypeName', title: '名稱', width: 97 }
                                ]],
                                panelHeight: 'auto',
                                onSelect: function (index, row) {
                                    // 檢查 itemdgIndex
                                    if (itemdgIndex === -1) {
                                        $.messager.alert(msglang.Title3, msglang.MsgSelectRow);
                                        return;
                                    }
                                    // 更新 itemdg 中的编辑行
                                    itemdg.datagrid('updateRow', {
                                        index: itemdgIndex,
                                        row: {
                                            TargetNo: '',
                                            TargetAbbr: ''
                                        }
                                    });
                                    // 结束编辑状态
                                    itemdg.datagrid('endEdit', itemdgIndex);

                                    // 如果需要继续编辑，可以立即重新开始编辑
                                    itemdg.datagrid('beginEdit', itemdgIndex);
                                }
                            }
                        }
                    },
                    { field: 'TargetNo', title: itemdglang.TargetNo, width: '5%', hidden: false, type: 'string' },//對象編號
                    { field: 'TargetAbbr', title: itemdglang.TargetAbbr, width: '8%', hidden: false, type: 'string' },//對象名稱
                    { field: 'AccProfitId', title: '會計部門Id', hidden: true, type: 'string' },//會計部門Id
                    { field: 'AccProfitNo', title: itemdglang.AccProfitNo, hidden: false, type: 'string' },//會計部門編號
                    { field: 'AccProfitName', title: itemdglang.AccProfitName, hidden: false, type: 'string' },//會計部門名稱
                    { field: 'AccDeptId', title: '成本中心Id', hidden: true, type: 'string' },//成本中心Id
                    { field: 'AccDeptNo', title: itemdglang.AccDeptNo, hidden: false, type: 'string' }, //成本中心編號
                    { field: 'AccDeptName', title: itemdglang.AccDeptName, hidden: false, type: 'string' },//成本中心名稱
                    { field: 'PayDeptId', title: '支付部門Id', hidden: true, type: 'string' },//支付部門Id
                    { field: 'PayDeptNo', title: itemdglang.PayDeptNo, hidden: false, type: 'string' },//支付部門編號
                    { field: 'PayDeptName', title: itemdglang.PayDeptName, hidden: false, type: 'string' },//支付部門名稱
                    { field: 'CheckType', title: '票據Type', hidden: true, type: 'string' },//票據Type
                    { field: 'CheckId', title: '票據Id', hidden: true, type: 'string' },//票據Id
                    { field: 'CheckNo', title: itemdglang.CheckNo, hidden: false, type: 'string', },//票據編號
                    { field: 'OffsetNo', title: itemdglang.OffsetNo , hidden: false, type: 'string' },//立沖編號
                    { field: 'CaseBillNo', title: itemdglang.CaseBillNo , hidden: false, type: 'string' },//來源單DocId
                    { field: 'SourceDocId', title: '來源單DocId', hidden: true, type: 'string' },//來源單DocId
                    { field: 'SourceSeqId', title: '來源單SeqId', hidden: true, type: 'string' },//來源單SeqId
                    { field: 'SourceDocSubTypeName', title: itemdglang.SourceDocSubTypeName, hidden: false, type: 'string' },//來源單別
                    { field: 'SourceNo', title: itemdglang.SourceNo , hidden: false, type: 'string' },//來源單號
                    { field: 'InitialProjectId', title: '原始單ProjectId', hidden: true, type: 'string' },//原始單ProjectId
                    { field: 'InitialDocSubType', title: '原始單DocSubType', hidden: true, type: 'string' },//原始單DocSubType
                    { field: 'InitialDocId', title: '原始單DocId', hidden: true, type: 'string' },//原始單DocId
                    { field: 'InitialDocSubTypeName', title: itemdglang.InitialDocSubTypeName, hidden: false, type: 'string' },//原始單別
                    { field: 'InitialNo', title: itemdglang.InitialNo, hidden: false, type: 'string' },//原始單號
                    {
                        field: 'ActivityType', title: itemdglang.ActivityType, hidden: false, type: 'string',
                        editor: {
                            type: 'combobox',
                            options: {
                                panelWidth: 200,
                                url: defaultUrl + controllerurl + functionurl + 'GetEditTableCode7',
                                valueField: 'ActivityType',
                                textField: 'ActivityType',
                                mode: 'remote',
                            }
                        }
                    },//活動類別
                ]],
                onClickRow: function (index, row) {
                    if (actioncode === 'edit' || actioncode === 'add') {
                        itemdg.datagrid('beginEdit', index); //啟用編輯
                        itemdgIndex = index; // 更新當前行索引
                        voucherDC();
                    }
                },
                onBeforeEdit: function (index, row) {
                    if (actioncode === 'edit' || actioncode === 'add') {
                        // 如果上一行正在編輯，結束它的編輯狀態
                        if (itemdgIndex !== undefined && itemdgIndex !== index) {
                            itemdg.datagrid('endEdit', itemdgIndex);
                        }
                    }
                },
                onAfterEdit: function (index, row, changes) {
                    if (actioncode === 'edit' || actioncode === 'add') {
                        // 使用 updateRow 更新數據源
                        itemdg.datagrid('updateRow', { index: index, row: row });
                        // 刷新該行以應用格式化並重構編輯狀態
                        itemdg.datagrid('refreshRow', index);
                        voucherDC();
                        // 重置當前的編輯行索引
                        itemdgIndex = undefined;

                    }
                },
                onCancelEdit: function (index, row) {
                    if (actioncode === 'edit' || actioncode === 'add') {
                        itemdgIndex = undefined; // 重置索引
                    }
                },
                onRowContextMenu: function (e, index, row) {
                    if (actioncode === 'edit' || actioncode === 'add') {
                        $('#mm').menu('show', {
                            left: e.pageX,
                            top: e.pageY
                        });
                        e.preventDefault();
                    }
                }
            });
        }
        function itemdgData(webdocid) {
            actionurl = defaultUrl + controllerurl + functionurl + 'GetVoucherItem?webdocid=' + webdocid;
            doajax("GET", actionurl, null, function (result) {
                if (result.success) {
                    itemdg.datagrid('loadData', result.data);

                    // VoucherDC計算
                    voucherDC();
                } else {
                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                    if (result.code == 'C0004') {
                        console.log(result.err);
                    }
                    itemdg.datagrid('loadData', '');
                }
            });
        }

        ///----- dlg_dg -----///
        function dlgdg1Set() {
            try {
                // 配置 datagrid
                dlgdg1.datagrid({
                    singleSelect: true,
                    striped: true,
                    columns: [[
                        { field: 'AccNo', title: '科目編號', type: 'string', sortable: true },
                        { field: 'AccName', title: '科目中文名稱', type: 'string', sortable: true },
                        { field: 'AccNoBy', title: '科目分類編號', hidden: true, type: 'string', sortable: true },
                        { field: 'AccNoByNameC', title: '科目分類中文名稱', hidden: true, type: 'string', sortable: true },
                        { field: 'AccGroupNo', title: '科目大類編號', hidden: true, type: 'string', sortable: true },
                        { field: 'AccGroupNameC', title: '科目大類中文名稱', hidden: true, type: 'string', sortable: true }
                    ]],
                    toolbar: '#toolbar1',
                    fitColumns: true,
                    onLoadSuccess: function (data) {
                        try {
                            $(this).datagrid('enableFilter');
                        } catch (error) {
                            console.error('dlgdg1_Filter error::', error);
                        }
                    }
                });
            } catch (error) {
                console.error('dlgdg1_Initialize error::', error);
            }

        }
        function dlgdg2Set() {
            // 配置datagrid
            dlgdg2.datagrid({
                singleSelect: true,
                striped: true,
                fitColumns: true,
                columns: [[
                    { field: 'CurrencyNo', title: '幣別' ,type: 'string', sortable: true },
                    { field: 'Rate', title: 'Rate', type: 'string',hidden:true},
                ]],
                fitColumns: true,
                onClickRow: function (index, row) {

                    // 將值填入itemdg並更新行
                    itemdg.datagrid('updateRow', {
                        index: itemdgIndex,
                        row: {
                            CurrencyNo: row.CurrencyNo,
                            Rate1: row.Rate
                        }
                    });

                    // 關閉對話框
                    $('#dlgEditCurrencyNo').dialog('close');
                }
            });

        }
        function dlgdg3Set() {
            dlgdg30.datagrid({
                singleSelect: true,
                striped: true,
                columns: [[
                    { field: 'Id', title: 'Id', width: 0, hidden: true, type: 'number'},
                    { field: 'PartnerNo', title: '廠商編號', width: 100, hidden: false },
                    { field: 'PartnerAbbr', title: '廠商簡稱', width: 100, hidden: false },
                    { field: 'PartnerName', title: '廠商名稱', width: 100, hidden: false },
                    { field: 'EmpNo', title: '負責採購', width: 100, hidden: false },
                    { field: 'EmpNameC', title: '採購名稱', width: 100, hidden: false },
                    { field: 'Tel1', title: '電話1', width: 100, hidden: false },
                    { field: 'Tel2', title: '電話2', width: 100, hidden: false },
                    { field: 'VatNo', title: '統一編號', width: 100, hidden: false },
                    { field: 'AreaName', title: '廠商地區', width: 100, hidden: false },
                    { field: 'ClassName', title: '廠商分類', width: 100, hidden: false },
                    { field: 'Grade', title: '廠商等級', width: 100, hidden: false },
                    { field: 'Addr', title: '廠商地址', width: 100, hidden: false },
                    {
                        field: 'IsStatus', title: '停止往來', width: 100, hidden: false, formatter: function (value, row, index) {
                            return '<input type="checkbox"' + (value ? ' ' : ' checked') + ' readonly>';
                        }
                    }
                ]],
                toolbar: '#toolbar30',
                fitColumns: true,
                onLoadSuccess: function (data) {
                    try {
                        $(this).datagrid('enableFilter');
                    } catch (error) {
                        console.error('dlgdg30_Filter error::', error);
                    }
                }
            });
            dlgdg31.datagrid({
                singleSelect: true,
                striped: true,
                columns: [[
                    { field: 'Id', title: 'Id', width: 100, hidden: true, type: 'number'},
                    { field: 'PartnerNo', title: '客戶編號', width: 100, hidden: false },
                    { field: 'PartnerAbbr', title: '客戶簡稱', width: 100, hidden: false },
                    { field: 'PartnerName', title: '客戶名稱', width: 100, hidden: false },
                    { field: 'EmpNo', title: '負責業務', width: 100, hidden: false },
                    { field: 'EmpNameC', title: '業務名稱', width: 100, hidden: false },
                    { field: 'Tel1', title: '電話1', width: 100, hidden: false },
                    { field: 'Tel2', title: '電話2', width: 100, hidden: false },
                    { field: 'VatNo', title: '統一編號', width: 100, hidden: false },
                    { field: 'AreaName', title: '客戶地區', width: 100, hidden: false },
                    { field: 'ClassName', title: '客戶分類', width: 100, hidden: false },
                    { field: 'Grade', title: '客戶等級', width: 100, hidden: false },
                    { field: 'Addr', title: '客戶地址', width: 100, hidden: false },
                    {
                        field: 'IsStatus', title: '停止往來', width: 100, hidden: false, formatter: function (value, row, index) {
                            return '<input type="checkbox"' + (value ? ' ' : ' checked') + ' readonly>';
                        }
                    }
                ]],
                toolbar: '#toolbar31',
                fitColumns: true,
                onLoadSuccess: function (data) {
                    try {
                        $(this).datagrid('enableFilter');
                    } catch (error) {
                        console.error('dlgdg31_Filter error::', error);
                    }
                }
            });
            dlgdg32.datagrid({
                singleSelect: true,
                striped: true,
                columns: [[
                    { field: 'Id', title: 'Id', width: 100, hidden: true, type: 'number' },
                    { field: 'DeptId', title: 'DeptId', width: 100, hidden: true },
                    { field: 'EmpNo', title: '員工編號', width: 100, hidden: false },
                    { field: 'EmpNameC', title: '中文名稱', width: 100, hidden: false },
                    { field: 'EmpNameE', title: '英文名稱', width: 100, hidden: false },
                    { field: 'DeptNo', title: '部門編號', width: 100, hidden: false },
                    { field: 'DeptName', title: '部門名稱', width: 100, hidden: false },
                    { field: 'Title', title: '職稱', width: 100, hidden: false },
                    { field: 'JobType', title: '任職狀況', width: 100, hidden: false }
                ]],
                toolbar: '#toolbar32',
                fitColumns: true,
                onLoadSuccess: function (data) {
                    try {
                        $(this).datagrid('enableFilter');
                    } catch (error) {
                        console.error('dlgdg32_Filter error:', error);
                    }
                }
            });
            dlgdg33.datagrid({
                singleSelect: true,
                striped: true,
                columns: [[
                    { field: 'Id', title: 'Id', width: 100, hidden: true, type: 'number'},
                    { field: 'Code', title: '銀行代碼', width: 100, hidden: false },
                    { field: 'BankCode', title: '銀行行號', width: 100, hidden: false },
                    { field: 'BankAbbr', title: '銀行簡稱', width: 100, hidden: false },
                    { field: 'AccountNo', title: '帳戶帳號', width: 100, hidden: false },
                    { field: 'AccountNameC', title: '帳戶中文名稱', width: 100, hidden: false },
                    { field: 'AccountNameE', title: '帳戶英文名稱', width: 100, hidden: false },
                    { field: 'AccNoAbbr', title: '帳戶簡稱', width: 100, hidden: false }
                ]],
                toolbar: '#toolbar33',
                fitColumns: true,
                onLoadSuccess: function (data) {
                    try {
                        $(this).datagrid('enableFilter');
                    } catch (error) {
                        console.error('dlgdg33_Filter error::', error);
                    }
                }
            });
        }
        function dlgdg4Set() {
            try {

                // 配置datagrid
                dlgdg4.datagrid({
                    singleSelect: true,
                    striped: true,
                    columns: [[
                        { field: 'DocId', title: 'DocId', type: 'string', hidden: true },
                        { field: 'Id', title: 'Id', type: 'number', hidden: true },
                        { field: 'DeptNo', title: '成本中心編號', type: 'string', hidden: false },
                        { field: 'DeptNameC', title: '成本中心中文', type: 'string', hidden: false },
                        { field: 'DeptNameE', title: '成本中心英文', type: 'string', hidden: false },
                        { field: 'CostLevel', title: 'CostLevel', type: 'string', hidden: true },
                    ]],
                    fitColumns: true,
                    onLoadSuccess: function (data) {
                        $(this).datagrid('enableFilter');
                    }
                });
            } catch (error) {
                console.error('初始化 datagrid 时出错:', error);
            }
        }
        function dlgdg5Set() {
            try {

                // 配置datagrid
                dlgdg5.datagrid({
                    singleSelect: true,
                    striped: true,
                    columns: [[
                        { field: 'DocId', title: 'DocId', type: 'string', hidden: true },
                        { field: 'Id', title: 'Id', type: 'number', hidden: true },
                        { field: 'DeptNo', title: '部門編號', type: 'string', hidden: false },
                        { field: 'TargetNameC', title: '中心中文名', type: 'string', hidden: false },
                        { field: 'TargetNameE', title: '中心英文名', type: 'string', hidden: false },
                        { field: 'DeptNameC', title: '部門中文名稱', type: 'string', hidden: false },
                        { field: 'DeptNameE', title: '部門英文名稱', type: 'string', hidden: false },
                    ]],
                    fitColumns: true,
                    onLoadSuccess: function (data) {
                        $(this).datagrid('enableFilter');
                    }
                });
            } catch (error) {
                console.error('初始化 datagrid 时出错:', error);
            }
        }
        //#endregion

        //#region 按鈕動作&狀態
        function btnClick(type) {
            let nowindex, row;
            switch (type) {
                //#region toolbar_maindg導覽&搜尋
                case 'first':
                    maindg.datagrid('selectRow', 0);
                    break;
                case 'previous':
                    row = maindg.datagrid('getSelected');
                    if (row) {
                        nowindex = maindg.datagrid('getRowIndex', row);
                    } else if (maindgindex >= 0) {
                        nowindex = maindgindex;
                    } else {
                        let rows = maindg.datagrid('getRows');
                        if (rows) {
                            nowindex = 0;
                        }
                    }
                    maindg.datagrid('selectRow', nowindex - 1);
                    break;
                case 'next':
                    row = maindg.datagrid('getSelected');
                    if (row) {
                        nowindex = maindg.datagrid('getRowIndex', row);
                    } else if (maindgindex >= 0) {
                        nowindex = maindgindex;
                    } else {
                        let rows = maindg.datagrid('getRows');
                        if (rows) {
                            nowindex = -1;
                        }
                    }
                    maindg.datagrid('selectRow', nowindex + 1);
                    break;
                    break;
                case 'last':
                    row = maindg.datagrid('getRows');
                    if (row) {
                        index = row.length;
                    }
                    maindg.datagrid('selectRow', index - 1);
                    break;
                case 'search':
                    break;
                //#endregion

                //#region toolbar_itemdg資料動作
                case 'add':
                    actioncode = 'add'; //狀態碼
                    btnEnableSet(actioncode);
                    infotabs.tabs('select', 1); //表頭表單切換
                    advtabs.tabs('select', 1); //進階資訊切換
                    maindg.datagrid('unselectRow', maindgIndex);
                    addForm(); //格式化、下拉選單初始化、預設欄位填值
                    itemdg.datagrid('loadData', { total: 0, rows: [] });//itemdg資料清空
                    $('.colMoneyD').textbox('setValue', '');
                    $('.colMoneyC').textbox('setValue', '');
                    $('.colMoney').textbox('setValue', '');
                    break;
                case 'edit':
                    row = maindg.datagrid('getSelected');
                    if (row != null) {
                        if (row.IsChecked == true) {
                            alert("此傳票無法編輯");
                        } else {
                            actioncode = 'edit';
                            btnEnableSet(actioncode);
                        }
                    } else {
                        alert("請選擇傳票進行編輯");
                    }
                    break;
                case 'save':
                    let maindata ; //表頭
                    let infodata = []; //表身
                    let dcdata;
                    let data = [];
                    let dosave ; //檢查是否能存
                    let maindatadg, infodatadg;
                    let rows = maindg.datagrid('getRows');

                    if (actioncode === 'add') {
                        if (rows.length > 1) {
                            $.messager.confirm('提醒', '已有期初傳票是否新增?', function (r) {
                                if (r) {
                                    dosave = saveCheck(actioncode);
                                    if (dosave) {
                                        maindata = {
                                            'BillDate': $('.fomBillDate').textbox('getValue'),
                                            'DocSubType': $('.fomDocSubType').textbox('getValue'),
                                            'DocSubTypeName': $('.fomDocSubTypeName').textbox('getValue'),
                                            'CompId': $('.fomCompNo').textbox('getValue'),
                                            'CompNo': $('.fomCompNo').textbox('getText'),
                                            'CompAbbr': $('.fomCompAbbr').textbox('getValue'),
                                            'VoucherType': $('.fomVoucherType').textbox('getValue'),
                                            'VoucherNameC': $('.fomVoucherNameC').textbox('getValue'),
                                            'EmpNo': $('.fomEmpNo').textbox('getValue'),
                                            'EmpNameC': $('.fomEmpNameC').textbox('getValue'),
                                            'DeptNo': $('.fomDeptNo').textbox('getValue'),
                                            'DeptName': $('.fomDeptName').textbox('getValue'),
                                            'BillNo': $('.fomBillNo').textbox('getValue'),
                                            'CurrencyNo': $('.fomCurrencyNo').textbox('getValue'),
                                            'CurrencySt': $('.fomCurrencySt').textbox('getValue'),
                                            'Rate1': $('.fomRate1').textbox('getValue'),
                                            /* 'Currency2': $('.fomCurrency2').textbox('getValue'),*/
                                            /*'Rate2': $('.fomRate2').textbox('getValue'),*/
                                            'TargetNo': $('.fomTargetNo').textbox('getValue')
                                        };
                                        infodatadg = itemdg.datagrid('getRows')
                                        infodata = infodatadg.map(function (row) {
                                            return {
                                                'Id': row.Id,
                                                'Linage': row.Linage,
                                                'AccNo': row.AccNo,
                                                'AccName': row.AccName,
                                                'DCTypeNo': row.DCTypeNo,
                                                'DCTypeNameC': row.DCTypeNameC,
                                                'CurrencyNo': row.CurrencyNo,
                                                'CurrencySt': row.CurrencySt,
                                                'Rate1': row.Rate1,
                                                'Money': row.Money,
                                                'Money1': row.Money1,
                                                'TargetId': row.TargetId,
                                                'TargetType': row.TargetType,
                                                'TargetNo': row.TargetNo,
                                                'TargetAbbr': row.TargetAbbr,
                                                'AccProfitId': row.AccProfitId,
                                                'AccProfitNo': row.AccProfitNo,
                                                'AccProfitName': row.AccProfitName,
                                                'AccDeptId': row.AccDeptId,
                                                'AccDeptNo': row.AccDeptNo,
                                                'AccDeptName': row.AccDeptName,
                                                'PayDeptId': row.PayDeptId,
                                                'PayDeptNo': row.PayDeptNo,
                                                'PayDeptName': row.PayDeptName,
                                                'CheckType': row.CheckType,
                                                'CheckId': row.CheckId,
                                                'CheckNo': row.CheckNo,
                                                'OffsetNo': row.OffsetNo,
                                                'SourceDocId': row.SourceDocId,
                                                'SourceSeqId': row.SourceSeqId,
                                                'SourceDocSubTypeName': row.SourceDocSubTypeName,
                                                'SourceNo': row.SourceNo,
                                                'InitialProjectId': row.InitialProjectId,
                                                'InitialDocSubType': row.InitialDocSubType,
                                                'InitialDocId': row.InitialDocId,
                                                'InitialDocSubTypeName': row.InitialDocSubTypeName,
                                                'InitialNo': row.InitialNo,
                                                'ActivityType': row.ActivityType,
                                                'Remark': row.Remark,
                                                'CaseBillNo': row.CaseBillNo,
                                            };
                                        });
                                        dcdata = {
                                            'Money11': $('.colMoneyD1').textbox('getValue'),
                                            'Money12': $('.colMoneyC1').textbox('getValue'),
                                            'Money21': $('.colMoneyD').textbox('getValue'),
                                            'Money22': $('.colMoneyC').textbox('getValue'),
                                            'Money1Dc': $('.colMoney1').textbox('getValue'),
                                            'Money2Dc': $('.colMoney').textbox('getValue'),
                                        };

                                        data = {
                                            Maindata: maindata,
                                            Infodata: infodata,
                                            Dcdata: dcdata
                                        };

                                        actionurl = defaultUrl + controllerurl + functionurl + 'AddData?type=begin';
                                        $.ajax({
                                            type: "POST",
                                            url: actionurl,
                                            data: JSON.stringify(data),
                                            contentType: "application/json",
                                            dataType: "json",
                                            success: function (response) {
                                                if (response.success) {
                                                    //$.messager.alert(msglang.Title2, '資料已成功儲存!');
                                                    pageReload(response.data, 'Add');
                                                } else {
                                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + response.code);
                                                    if (response.code == 'C0004') {
                                                        console.log(response.err);
                                                    }
                                                }
                                            },
                                            error: function (xhr, status, errorThrown) {
                                                $.messager.alert(msglang.Title2, msglang.MsgErrAja);
                                                console.error(status, errorThrown);
                                            }
                                        });
                                    } else {
                                        $.messager.alert(msglang.Title2, msglang.MsgErrDc);
                                    }
                                }
                            });
                        }
                        dosave = saveCheck(actioncode);
                        if (dosave) {
                            maindata = {
                                'BillDate': $('.fomBillDate').textbox('getValue'),
                                'DocSubType': $('.fomDocSubType').textbox('getValue'),
                                'DocSubTypeName': $('.fomDocSubTypeName').textbox('getValue'),
                                'CompId': $('.fomCompNo').textbox('getValue'),
                                'CompNo': $('.fomCompNo').textbox('getText'),
                                'CompAbbr': $('.fomCompAbbr').textbox('getValue'),
                                'VoucherType': $('.fomVoucherType').textbox('getValue'),
                                'VoucherNameC': $('.fomVoucherNameC').textbox('getValue'),
                                'EmpNo': $('.fomEmpNo').textbox('getValue'),
                                'EmpNameC': $('.fomEmpNameC').textbox('getValue'),
                                'DeptNo': $('.fomDeptNo').textbox('getValue'),
                                'DeptName': $('.fomDeptName').textbox('getValue'),
                                'BillNo': $('.fomBillNo').textbox('getValue'),
                                'CurrencyNo': $('.fomCurrencyNo').textbox('getValue'),
                                'CurrencySt': $('.fomCurrencySt').textbox('getValue'),
                                'Rate1': $('.fomRate1').textbox('getValue'),
                                /* 'Currency2': $('.fomCurrency2').textbox('getValue'),*/
                                /*'Rate2': $('.fomRate2').textbox('getValue'),*/
                                'TargetNo': $('.fomTargetNo').textbox('getValue')
                            };
                            infodatadg = itemdg.datagrid('getRows')
                            infodata = infodatadg.map(function (row) {
                                return {
                                    'Id': row.Id,
                                    'Linage': row.Linage,
                                    'AccNo': row.AccNo,
                                    'AccName': row.AccName,
                                    'DCTypeNo': row.DCTypeNo,
                                    'DCTypeNameC': row.DCTypeNameC,
                                    'CurrencyNo': row.CurrencyNo,
                                    'CurrencySt': row.CurrencySt,
                                    'Rate1': row.Rate1,
                                    'Money': row.Money,
                                    'Money1': row.Money1,
                                    'TargetId': row.TargetId,
                                    'TargetType': row.TargetType,
                                    'TargetNo': row.TargetNo,
                                    'TargetAbbr': row.TargetAbbr,
                                    'AccProfitId': row.AccProfitId,
                                    'AccProfitNo': row.AccProfitNo,
                                    'AccProfitName': row.AccProfitName,
                                    'AccDeptId': row.AccDeptId,
                                    'AccDeptNo': row.AccDeptNo,
                                    'AccDeptName': row.AccDeptName,
                                    'PayDeptId': row.PayDeptId,
                                    'PayDeptNo': row.PayDeptNo,
                                    'PayDeptName': row.PayDeptName,
                                    'CheckType': row.CheckType,
                                    'CheckId': row.CheckId,
                                    'CheckNo': row.CheckNo,
                                    'OffsetNo': row.OffsetNo,
                                    'SourceDocId': row.SourceDocId,
                                    'SourceSeqId': row.SourceSeqId,
                                    'SourceDocSubTypeName': row.SourceDocSubTypeName,
                                    'SourceNo': row.SourceNo,
                                    'InitialProjectId': row.InitialProjectId,
                                    'InitialDocSubType': row.InitialDocSubType,
                                    'InitialDocId': row.InitialDocId,
                                    'InitialDocSubTypeName': row.InitialDocSubTypeName,
                                    'InitialNo': row.InitialNo,
                                    'ActivityType': row.ActivityType,
                                    'Remark': row.Remark,
                                    'CaseBillNo': row.CaseBillNo,
                                };
                            });
                            dcdata = {
                                'Money11': $('.colMoneyD1').textbox('getValue'),
                                'Money12': $('.colMoneyC1').textbox('getValue'),
                                'Money21': $('.colMoneyD').textbox('getValue'),
                                'Money22': $('.colMoneyC').textbox('getValue'),
                                'Money1Dc': $('.colMoney1').textbox('getValue'),
                                'Money2Dc': $('.colMoney').textbox('getValue'),
                            };

                            data = {
                                Maindata: maindata,
                                Infodata: infodata,
                                Dcdata: dcdata
                            };

                            actionurl = defaultUrl + controllerurl + functionurl + 'AddData?type=begin';
                            $.ajax({
                                type: "POST",
                                url: actionurl,
                                data: JSON.stringify(data),
                                contentType: "application/json",
                                dataType: "json",
                                success: function (response) {
                                    if (response.success) {
                                        //$.messager.alert(msglang.Title2, '資料已成功儲存!');
                                        pageReload(response.data, 'Add');
                                    } else {
                                        $.messager.alert(msglang.Title2, msglang.MsgErrCode + response.code);
                                        if (response.code == 'C0004') {
                                            console.log(response.err);
                                        }
                                    }
                                },
                                error: function (xhr, status, errorThrown) {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrAja);
                                    console.error(status, errorThrown);
                                }
                            });
                        } else {
                            $.messager.alert(msglang.Title2, msglang.MsgErrDc);
                        }
                    }
                    if (actioncode === 'edit') {
                        dosave = saveCheck(actioncode);
                        if (dosave) {
                            maindatadg = maindg.datagrid('getRows')[maindgIndex]
                            maindata = {
                                'WebId': maindatadg.WebId,
                                'BillDate': maindatadg.BillDate,
                                'DocSubType': maindatadg.DocSubType,
                                'DocSubTypeName': maindatadg.DocSubTypeName,
                                'CompNo': maindatadg.CompNo,
                                'CompAbbr': maindatadg.CompAbbr,
                                'VoucherType': maindatadg.VoucherType,
                                'VoucherNameC': maindatadg.VoucherNameC,
                                'EmpNo': maindatadg.EmpNo,
                                'EmpNameC': maindatadg.EmpNameC,
                                'DeptNo': maindatadg.DeptNo,
                                'DeptNam': maindatadg.DeptName,
                                'BillNo': maindatadg.BillNo,
                                'CurrencyNo': maindatadg.CurrencyNo,
                                'CurrencySt': maindatadg.CurrencySt,
                                'Rate1': maindatadg.Rate1,
                                //'CurrencyTw2': maindatadg.CurrencyTw2,
                                //'Rate2': maindatadg.Rate2,
                                'TargetNo': maindatadg.TargetNo,
                            };
                            infodatadg = itemdg.datagrid('getRows')
                            infodata = infodatadg.map(function (row) {
                                return {
                                    'WebId': row.WebId,
                                    'Id': row.Id,
                                    'Linage': row.Linage,
                                    'AccNo': row.AccNo,
                                    'AccName': row.AccName,
                                    'DCTypeNo': row.DCTypeNo,
                                    'DCTypeNameC': row.DCTypeNameC,
                                    'CurrencyNo': row.CurrencyNo,
                                    'CurrencySt': row.CurrencySt,
                                    'Rate1': row.Rate1,
                                    'Money': row.Money,
                                    'Money1': row.Money1,
                                    'TargetId': row.TargetId,
                                    'TargetType': row.TargetType,
                                    'TargetNo': row.TargetNo,
                                    'TargetAbbr': row.TargetAbbr,
                                    'AccProfitId': row.AccProfitId,
                                    'AccProfitNo': row.AccProfitNo,
                                    'AccProfitName': row.AccProfitName,
                                    'AccDeptId': row.AccDeptId,
                                    'AccDeptNo': row.AccDeptNo,
                                    'AccDeptName': row.AccDeptName,
                                    'PayDeptId': row.PayDeptId,
                                    'PayDeptNo': row.PayDeptNo,
                                    'PayDeptName': row.PayDeptName,
                                    'CheckType': row.CheckType,
                                    'CheckId': row.CheckId,
                                    'CheckNo': row.CheckNo,
                                    'OffsetNo': row.OffsetNo,
                                    'SourceDocId': row.SourceDocId,
                                    'SourceSeqId': row.SourceSeqId,
                                    'SourceDocSubTypeName': row.SourceDocSubTypeName,
                                    'SourceNo': row.SourceNo,
                                    'SourceSt': row.SourceSt,
                                    'InitialProjectId': row.InitialProjectId,
                                    'InitialDocSubType': row.InitialDocSubType,
                                    'InitialDocId': row.InitialDocId,
                                    'InitialDocSubTypeName': row.InitialDocSubTypeName,
                                    'InitialNo': row.InitialNo,
                                    'ActivityType': row.ActivityType,
                                    'Remark': row.Remark,
                                    'CaseBillNo': row.CaseBillNo,
                                };
                            });
                            dcdata = {
                                'Money11': $('.colMoneyD1').textbox('getValue'),
                                'Money12': $('.colMoneyC1').textbox('getValue'),
                                'Money21': $('.colMoneyD').textbox('getValue'),
                                'Money22': $('.colMoneyC').textbox('getValue'),
                                'Money1Dc': $('.colMoney1').textbox('getValue'),
                                'Money2Dc': $('.colMoney').textbox('getValue'),
                            };
                            data = {
                                Maindata: maindata,
                                Infodata: infodata,
                                Dcdata: dcdata
                            };

                            actionurl = defaultUrl + controllerurl + functionurl + 'EditData';
                            $.ajax({
                                type: "POST",
                                url: actionurl,
                                data: JSON.stringify(data),
                                contentType: "application/json",
                                dataType: "json",
                                success: function (response) {
                                    if (response.success) {
                                        //$.messager.alert(msglang.Title2, '資料已成功儲存!');
                                        pageReload(response.data, 'Edit');
                                    } else {
                                        $.messager.alert(msglang.Title2, msglang.MsgErrCode + response.code);
                                        if (response.code == 'C0004') {
                                            console.log(response.err);
                                        }
                                    }
                                },
                                error: function (xhr, status, errorThrown) {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrAja);
                                    console.error("Status: " + status);
                                    console.error("Error: " + errorThrown);
                                    console.error("Response: " + xhr.responseText);
                                }
                            });
                        } else {
                            $.messager.alert(msglang.Title2, msglang.MsgErrDc);
                        }
                    }
                    if (actioncode != 'add' && actioncode != 'edit') {
                        actioncode = 'view';
                        btnEnableSet(actioncode);
                        $.messager.alert(msglang.Title2, msglang.MsgActionErr);
                    }
                    break;
                case 'refresh':
                    break;
                case 'cancel':
                    if (actioncode == 'add') {
                        $.messager.confirm(msglang.Title1, msglang.MsgCfmCancel, function (r) {
                            if (r) {
                                //addForm欄位清空
                                $('#addForm .easyui-datebox').datebox('clear');
                                $('#addForm .easyui-combogrid').combogrid('clear');
                                $('#addForm .easyui-textbox').textbox('clear');
                                //表身清空
                                itemdg.datagrid('loadData', { total: 0, rows: [] });
                                infotabs.tabs('select', 0);//表頭表單切換
                                advtabs.tabs('select', 0);//進階資訊切換

                                actioncode = 'view';
                                btnEnableSet(actioncode);
                                maindg.datagrid('selectRow', maindgIndex);//還原原先選擇列
                            } else {
                                return;
                            }
                        });
                    } else if (actioncode == 'edit') {
                        $.messager.confirm(msglang.Title1, msglang.MsgCfmCancel, function (r) {
                            if (r) {
                                //itemdg.datagrid('endEdit', itemdgIndex);
                                actioncode = 'view';
                                btnEnableSet(actioncode);
                                maindg.datagrid('unselectRow', maindgIndex);
                                maindg.datagrid('selectRow', maindgIndex);
                            } else {
                                return;
                            }
                        });
                    }

                    break;
                case 'delete':
                    row = maindg.datagrid('getSelected');
                    if (row != null) {
                        $.messager.confirm('提醒', '是否刪除期初傳票?', function (r) {
                            if (r) {
                                actionurl = defaultUrl + controllerurl + functionurl + 'DeleteData?webid=' + row.WebId;
                                doajax("Delete", actionurl, null, function (result) {
                                    if (result.success) {
                                        pageReload(result.data, 'Delete');
                                    } else {
                                        $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                        if (result.code == 'C0004') {
                                            console.log(result.err);
                                        }
                                        itemdg.datagrid('loadData', '');
                                    }
                                });
                            }
                        });
                    } else {
                        alert("請選擇傳票進行編輯");
                    }
                    break;
                case 'lock':
                    row = maindg.datagrid('getSelected');
                    if (row != null) {
                        if (actioncode == 'add' || actioncode == 'edit') {
                            $.messager.alert(msglang.Title2, msglang.MsgErrSaveFirst);
                            return;
                        }
                        $.messager.confirm(msglang.Title1, msglang.MsgCfmSend, function (r) {
                            if (r) {
                                actionurl = defaultUrl + controllerurl + functionurl + 'VoucherStatus?webid=' + row.WebId +'&type=lock';
                                doajax("POST", actionurl, null, function (result) {
                                    if (result.success) {
                                        //$.messager.alert(msglang.Title2, '單號：' + response.data + '已覆核。');
                                        pageReload(result.data, 'Lock');
                                    } else {
                                        $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                        if (result.code == 'C0004') {
                                            console.log(result.err);
                                        }
                                        itemdg.datagrid('loadData', '');
                                    }
                                });
                            } else {
                                return;
                            }
                        });
                    } else {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow2);
                    }

                    break;
                //#endregion

                //#region dlg_按鈕動作
                case 'dlgdg1insert':
                    var selectedRow = dlgdg1.datagrid('getSelected');
                    if (!selectedRow) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow3);
                        return;
                    }

                    // 檢查 itemdgIndex
                    if (itemdgIndex === -1) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow);
                        return;
                    }

                    if (actioncode === 'add' || actioncode === 'edit') {
                        fitemdgIndex = itemdgIndex;
                        itemdg.datagrid('endEdit', itemdgIndex);
                        itemdg.datagrid('updateRow', {
                            index: fitemdgIndex,
                            row: {
                                AccNo: selectedRow.AccNo,
                                AccName: selectedRow.AccName,
                                //AccNoBy: selectedRow.AccNoBy,
                                //AccNoByNameC: selectedRow.AccNoByNameC,
                                //AccGroupNo: selectedRow.AccGroupNo,
                                //AccGroupNameC: selectedRow.AccGroupNameC,
                                //Remark: '',
                                DCTypeNo: selectedRow.DCTypeNo,
                            }
                        });
                    }

                    $('#dlgEditAccNo').dialog('close');
                    break;
                case 'dlgdg1exit':
                    $('#dlgEditAccNo').dialog('close');
                    break;
                case 'dlgdg30insert':
                    var selectedRow = dlgdg30.datagrid('getSelected');
                    if (!selectedRow) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow3);
                        return;
                    }
                    if (itemdgIndex === -1) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow);
                        return;
                    }
                    itemdg.datagrid('updateRow', {
                        index: itemdgIndex,
                        row: {
                            TargetNo: selectedRow.PartnerNo,
                            TargetAbbr: selectedRow.PartnerAbbr,
                        }
                    });
                    $('#dlgEditTargetNo').dialog('close');
                    break;
                case 'dlgdg31insert':
                    var selectedRow = dlgdg31.datagrid('getSelected');
                    if (!selectedRow) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow3);
                        return;
                    }
                    if (itemdgIndex === -1) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow);
                        return;

                    }
                    itemdg.datagrid('updateRow', {
                        index: itemdgIndex,
                        row: {
                            TargetNo: selectedRow.PartnerNo,
                            TargetAbbr: selectedRow.PartnerAbbr,
                        }
                    });
                    $('#dlgEditTargetNo').dialog('close');
                    break;
                case 'dlgdg32insert':
                    var selectedRow = dlgdg32.datagrid('getSelected');
                    if (!selectedRow) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow3);
                        return;
                    }
                    if (itemdgIndex === -1) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow);
                        return;

                    }
                    itemdg.datagrid('updateRow', {
                        index: itemdgIndex,
                        row: {
                            TargetNo: selectedRow.EmpNo,
                            TargetAbbr: selectedRow.EmpNameC,
                        }
                    });
                    $('#dlgEditTargetNo').dialog('close');
                    break;
                case 'dlgdg33insert':
                    var selectedRow = dlgdg33.datagrid('getSelected');
                    if (!selectedRow) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow3);
                        return;
                    }
                    if (itemdgIndex === -1) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow);
                        return;

                    }
                    itemdg.datagrid('updateRow', {
                        index: itemdgIndex,
                        row: {
                            TargetNo: selectedRow.Code,
                            TargetAbbr: selectedRow.field,
                        }
                    });
                    $('#dlgEditTargetNo').dialog('close');
                    break;
                case 'dlgdg3exit':
                    $('#dlgEditTargetNo').dialog('close');
                    break;
                case 'dlgdg4insert':
                    var selectedRow = dlgdg4.datagrid('getSelected');
                    if (!selectedRow) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow3);
                        return;
                    }
                    if (itemdgIndex === -1) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow);
                        return;
                    }
                    // 更新 itemdg 中的编辑行
                    itemdg.datagrid('updateRow', {
                        index: itemdgIndex,
                        row: {
                            AccDeptNo: selectedRow.DeptNo,
                            AccDeptName: selectedRow.DeptNameC,
                        }
                    });

                    $('#dlgEditAccDept').dialog('close');
                    break;
                case 'dlgdg4exit':
                    $('#dlgEditAccDept').dialog('close');
                    break;
                case 'dlgdg5insert':
                    var selectedRow = dlgdg5.datagrid('getSelected');
                    if (!selectedRow) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow3);
                        return;
                    }
                    if (itemdgIndex === -1) {
                        $.messager.alert(msglang.Title2, msglang.MsgSelectRow);
                        return;
                    }
                    // 更新 itemdg 中的编辑行
                    itemdg.datagrid('updateRow', {
                        index: itemdgIndex,
                        row: {
                            PayDeptNo: selectedRow.DeptNo,
                            PayDeptName: selectedRow.DeptNameC,
                        }
                    });

                    $('#dlgEditPayDept').dialog('close');
                    break;
                case 'dlgdg5exit':
                    $('#dlgEditPayDept').dialog('close');
                    break;
                //#endregion
            }
        }
        function btnEnableSet(type) {
            switch (type) {
                case 'view':
                    $('#btnAdd').linkbutton('enable');
                    $('#btnEdit').linkbutton('enable');
                    $('#btnSave').linkbutton('disable');
                    $('#btnDetail').linkbutton('disable');
                    $('#btnRefresh').linkbutton('enable');
                    $('#btnCancel').linkbutton('disable');
                    $('#btnDelete').linkbutton('enable');
                    break;
                case 'add':
                    $('#btnAdd').linkbutton('disable');
                    $('#btnEdit').linkbutton('disable');
                    $('#btnSave').linkbutton('enable');
                    $('#btnDetail').linkbutton('disable');
                    $('#btnRefresh').linkbutton('disable');
                    $('#btnCancel').linkbutton('enable');
                    $('#btnDelete').linkbutton('disable');
                    break;
                case 'edit':
                    $('#btnAdd').linkbutton('disable');
                    $('#btnEdit').linkbutton('disable');
                    $('#btnSave').linkbutton('enable');
                    $('#btnDetail').linkbutton('disable');
                    $('#btnRefresh').linkbutton('disable');
                    $('#btnCancel').linkbutton('enable');
                    $('#btnDelete').linkbutton('disable');
                    break;
                case 'cancel':
                    break;
                default:
                    $('#btnAdd').linkbutton('enable');
                    $('#btnEdit').linkbutton('enable');
                    $('#btnSave').linkbutton('disable');
                    $('#btnDetail').linkbutton('disable');
                    $('#btnRefresh').linkbutton('enable');
                    $('#btnCancel').linkbutton('disable');
                    $('#btnDelete').linkbutton('enable');


            }
        }
        //#endregion

        //#region 功能函式
        // 自定義doajax
        function doajax(type, url, data, successCallback, errorCallback) {
            $.ajax({
                type: type,
                url: url,
                data: data,
                success: function (response) {
                    if (typeof successCallback === 'function') {
                        successCallback(response);
                    }
                },
                error: function (xhr, status, errorThrown) {
                    if (typeof errorCallback === 'function') {
                        errorCallback(xhr, status, errorThrown);
                    }
                }
            });
        }

        // 表頭、進階資料、借貸平衡填值
        function tableHeadData(row) {
            $('.colBillDate').textbox('setValue', row.BillDate);
            $('.colDocSubType').textbox('setValue', row.DocSubType);
            $('.colDocSubTypeName').textbox('setValue', row.DocSubTypeName);
            $('.colCompNo').textbox('setValue', row.CompNo);
            $('.colCompAbbr').textbox('setValue', row.CompAbbr);
            $('.colVoucherType').textbox('setValue', row.VoucherType);
            $('.colVoucherNameC').textbox('setValue', row.VoucherNameC);
            $('.colEmpNo').textbox('setValue', row.EmpNo);
            $('.colEmpNameC').textbox('setValue', row.EmpNameC);
            $('.colDeptNo').textbox('setValue', row.DeptNo);
            $('.colDeptName').textbox('setValue', row.DeptName);
            $('.colBillNo').textbox('setValue', row.BillNo);
            $('.colCurrencyNo').textbox('setValue', row.CurrencyNo);
            $('.colCurrencySt').textbox('setValue', row.CurrencySt);
            $('.colRate1').textbox('setValue', row.Rate1);
            /* $('.colCurrency2').textbox('setValue',row.VoucherNameC);*/
            /* $('.colRate2').textbox('setValue', row.Rate2);*/
            $('.colTargetNo').textbox('setValue', row.TargetNo);
            //進階資料
            $('.colLedger').textbox('setValue', '帳簿1');
            $('.colCompNo').textbox('setValue', row.CompNo);
            $('.colCompAbbr').textbox('setValue', row.CompAbbr);
            $('.colAccDocType').textbox('setValue', row.AccDocType);
            $('.colSourceDocSubTypeName').textbox('setValue', row.SourceDocSubTypeName);
            $('.colActivityType').textbox('setValue', row.ActivityType);
            $('.colSourceNo').textbox('setValue', row.SourceNo);
            //借貸平衡
            $('.colCurrencyD').textbox('setValue', row.CurrencySt);
            $('.colCurrencyC').textbox('setValue', row.CurrencySt);
            $('.colCurrency').textbox('setValue', row.CurrencySt);
        }

        // 明細編輯
        function updateMoney1(type, newValue) {
            var row;
            var newMoney1;
            if (itemdgIndex !== undefined) {
                if (type == '0') {
                    row = itemdg.datagrid('getRows')[itemdgIndex]
                    newMoney1 = math.chain(newValue).multiply(row.Rate1).done();
                    fitemdgIndex = itemdgIndex;
                    itemdg.datagrid('endEdit', itemdgIndex);
                    itemdg.datagrid('updateRow', {
                        index: fitemdgIndex,
                        row: {
                            Money: newValue,
                            Money1: newMoney1
                        }
                    });

                }
                if (type == '1') {
                    row = itemdg.datagrid('getRows')[itemdgIndex]
                    newMoney1 = math.chain(row.Money).multiply(newValue).done();
                    fitemdgIndex = itemdgIndex;
                    itemdg.datagrid('endEdit', itemdgIndex);
                    itemdg.datagrid('updateRow', {
                        index: fitemdgIndex,
                        row: {
                            Rate1: newValue,
                            Money1: newMoney1
                        }
                    });
                }

            }
            if (type == '2') {
                row = itemdg.datagrid('getRows')[fitemdgIndex]
                newMoney1 = math.chain(row.Money).multiply(newValue).done();
                itemdg.datagrid('updateRow', {
                    index: fitemdgIndex,
                    row: {
                        Money1: newMoney1
                    }
                });
            }
        }
        function updateRate(type, newValue) {
            if (itemdgIndex !== undefined) {
                var row = itemdg.datagrid('getRows')[itemdgIndex];
                var newRate;
                if (type == '0') {//combobox切換
                    newRate = objCurrencyNo.data.find(function (item) {
                        return item.CurrencyNo === newValue;
                    });

                    fitemdgIndex = itemdgIndex;
                    itemdg.datagrid('endEdit', itemdgIndex);
                    itemdg.datagrid('updateRow', {
                        index: fitemdgIndex,
                        row: {
                            Rate1: newRate.Rate
                        }
                    });
                    updateMoney1('2', newRate.Rate);
                }
                if (type == '1') {//輸入Money1
                    newRate = math.chain(newValue).divide(row.Money).done();
                    fitemdgIndex = itemdgIndex;
                    itemdg.datagrid('endEdit', itemdgIndex);
                    itemdg.datagrid('updateRow', {
                        index: fitemdgIndex,
                        row: {
                            Rate1: newRate
                        }
                    });

                }
            }
        }

        // 傳票借貸合計(使用記帳金額計算)
        function voucherDC() {
            let totalDMoney = 0, totalDMoney1 = 0;
            let totalCMoney = 0, totalCMoney1 = 0;
            let balance = 0, balance1 = 0;
            let rows = itemdg.datagrid('getRows');

            for (let i = 0; i < rows.length; i++) {
                if (rows[i].DCTypeNo === 'D') {
                    totalDMoney = math.chain(totalDMoney).add(rows[i].Money1).done();
                    totalDMoney1 = math.chain(totalDMoney1).add(rows[i].Money).done();
                } else if (rows[i].DCTypeNo === 'C') {
                    totalCMoney = math.chain(totalCMoney).add(rows[i].Money1).done();
                    totalCMoney1 = math.chain(totalCMoney1).add(rows[i].Money).done();
                }
            }
            balance = math.abs(math.chain(totalDMoney).subtract(totalCMoney).done());
            balance1 = math.abs(math.chain(totalDMoney1).subtract(totalCMoney1).done());

            // 將計算後的值填入對應的 input 元素
            $('.colMoneyD').textbox('setValue', totalDMoney);
            $('.colMoneyD1').textbox('setValue', totalDMoney1);
            $('.colMoneyC').textbox('setValue', totalCMoney);
            $('.colMoneyC1').textbox('setValue', totalCMoney1);
            $('.colMoney').textbox('setValue', balance);
            $('.colMoney1').textbox('setValue', balance1);
        }

        // addForm必填欄位
        function saveCheck(type) {
            let check1 = true; //表頭必填欄位
            let check2 = false;//借貸平衡

            // check1
            if (type === 'add') {
                let form = document.getElementById('addForm');
                let inputs = form.querySelectorAll('[required]');

                inputs.forEach(function (input) {
                    if (!input.value) {
                        check1 = false;
                        input.classList.add('error');
                    } else {
                        input.classList.remove('error');
                    }
                });
            } else if (type === 'edit') {
                check1 = true;
            }

            // check2
            voucherDC();
            let dcbalance = $('.colMoney').textbox('getValue');
            if (dcbalance == 0) {
                check2 = true;
            }

            // return
            if (check1 && check2 ) {
                return true;
            } else {
                return false;
            }
        }

        // 右鍵功能
        function menuHandler(item) {
            var rowCount, currentRow, newRow;
            switch (item.name) {
                case 'add':
                    rowCount = itemdg.datagrid('getRows').length;
                    // 先檢查 itemdg 是否被正確初始化
                    if (!itemdg) {
                        console.error('itemdg is not initialized');
                        return;
                    }
                    itemdg.datagrid('appendRow', {
                        Id: '',
                        Linage: rowCount + 1,
                        AccNo: '',
                        AccName: '',
                        DCTypeNo: '',
                        CurrencyNo: $('.fomCurrencyNo').textbox('getValue'),
                        CurrencySt: $('.fomCurrencySt').textbox('getValue'),
                        Rate1: $('.fomRate1').textbox('getValue'),
                        Money: 0,
                        TargetId: '',
                        TargetType: '',
                        TargetNo: '',
                        AccProfitId: '',
                        AccProfitNo: '',
                        AccDeptId: '',
                        AccDeptNo: '',
                        PayDeptId: '',
                        PayDeptNo: '',
                        CheckType: '',
                        CheckId: '',
                        CheckNo: '',
                        OffsetNo: '',
                        SourceDocId: '',
                        SourceSeqId: '',
                        SourceDocSubTypeName: '',
                        InitialProjectId: '',
                        InitialDocSubType: '',
                        InitialDocId: '',
                        InitialDocSubTypeName: '',
                        ActivityType: '',
                        Remark: '',
                        DCTypeNameC: '',
                        CurrencyNoNote: '',
                        Money1: 0,
                        TargetAbbr: '',
                        AccProfitName: '',
                        AccDeptName: '',
                        PayDeptName: '',
                        CaseBillNo: '',
                        SourceNo: '',
                        InitialNo: ''
                    });
                    var newIndex = itemdg.datagrid('getRows').length - 1;
                    itemdg.datagrid('selectRow', newIndex).datagrid('beginEdit', newIndex);
                    itemdgIndex = newIndex;
                    break;
                case 'addF':
                    if (itemdgIndex !== undefined) {
                        itemdg.datagrid('insertRow', {
                            index: itemdgIndex, // 指定插入到當前行之前
                            row: {
                                Id: '',
                                Linage: '',
                                AccNo: '',
                                AccName: '',
                                DCTypeNo: '',
                                CurrencyNo: $('.fomCurrencyNo').textbox('getValue'),
                                CurrencySt: $('.fomCurrencySt').textbox('getValue'),
                                Rate1: $('.fomRate1').textbox('getValue'),
                                Money: 0,
                                TargetId: '',
                                TargetType: '',
                                TargetNo: '',
                                AccProfitId: '',
                                AccProfitNo: '',
                                AccDeptId: '',
                                AccDeptNo: '',
                                PayDeptId: '',
                                PayDeptNo: '',
                                CheckType: '',
                                CheckId: '',
                                CheckNo: '',
                                OffsetNo: '',
                                SourceDocId: '',
                                SourceSeqId: '',
                                SourceDocSubTypeName: '',
                                InitialProjectId: '',
                                InitialDocSubType: '',
                                InitialDocId: '',
                                InitialDocSubTypeName: '',
                                ActivityType: '',
                                Remark: '',
                                DCTypeNameC: '',
                                CurrencyNoNote: '',
                                Money1: 0,
                                TargetAbbr: '',
                                AccProfitName: '',
                                AccDeptName: '',
                                PayDeptName: '',
                                CaseBillNo: '',
                                SourceNo: '',
                                InitialNo: ''
                            }
                        });

                        rowCount = itemdg.datagrid('getRows').length;
                        for (var i = 0; i < rowCount; i++) {
                            itemdg.datagrid('updateRow', {
                                index: i,
                                row: {
                                    Linage: i + 1  // Start numbering from 1
                                }
                            });
                        }

                        // 選擇並開始編輯新插入的行
                        itemdg.datagrid('selectRow', rowIndex).datagrid('beginEdit', rowIndex);
                        itemdgIndex = rowIndex; // 更新當前行索引
                    } else {
                        $.messager.alert(msglang.Title3, '請先選擇一行進行操作');
                    }

                    break;
                case 'addB':
                    if (itemdgIndex !== undefined) {
                        itemdg.datagrid('insertRow', {
                            index: itemdgIndex+1, // 指定插入到當前行之前
                            row: {
                                Id: '',
                                Linage: '',
                                AccNo: '',
                                AccName: '',
                                DCTypeNo: '',
                                CurrencyNo: $('.fomCurrencyNo').textbox('getValue'),
                                CurrencySt: $('.fomCurrencySt').textbox('getValue'),
                                Rate1: $('.fomRate1').textbox('getValue'),
                                Money: 0,
                                TargetId: '',
                                TargetType: '',
                                TargetNo: '',
                                AccProfitId: '',
                                AccProfitNo: '',
                                AccDeptId: '',
                                AccDeptNo: '',
                                PayDeptId: '',
                                PayDeptNo: '',
                                CheckType: '',
                                CheckId: '',
                                CheckNo: '',
                                OffsetNo: '',
                                SourceDocId: '',
                                SourceSeqId: '',
                                SourceDocSubTypeName: '',
                                InitialProjectId: '',
                                InitialDocSubType: '',
                                InitialDocId: '',
                                InitialDocSubTypeName: '',
                                ActivityType: '',
                                Remark: '',
                                DCTypeNameC: '',
                                CurrencyNoNote: '',
                                Money1: 0,
                                TargetAbbr: '',
                                AccProfitName: '',
                                AccDeptName: '',
                                PayDeptName: '',
                                CaseBillNo: '',
                                SourceNo: '',
                                InitialNo: ''
                            }
                        });

                        rowCount = itemdg.datagrid('getRows').length;
                        for (var i = 0; i < rowCount; i++) {
                            itemdg.datagrid('updateRow', {
                                index: i,
                                row: {
                                    Linage: i + 1  // Start numbering from 1
                                }
                            });
                        }

                        // 選擇並開始編輯新插入的行
                        itemdg.datagrid('selectRow', rowIndex).datagrid('beginEdit', rowIndex);
                        itemdgIndex = rowIndex; // 更新當前行索引
                    } else {
                        $.messager.alert(msglang.Title3, '請先選擇一行進行操作');
                    }

                    break;
                case 'addReverse':
                    if (itemdgIndex == null || itemdgIndex < 0) {
                        $.messager.alert(msglang.Title3, '請先選擇一行進行操作');
                        return;
                    }
                    currentRow = itemdg.datagrid('getRows')[itemdgIndex];
                    // Determine the reverse values based on the current selection
                    if (currentRow.DCTypeNo === 'D') {
                        reverseDCTypeNo = 'C';
                    } else if (currentRow.DCTypeNo === 'C') {
                        reverseDCTypeNo = 'D';
                    } else {
                        $.messager.alert(msglang.Title3, '當前行的借貸方向不正確');
                        return;
                    }
                    rowCount = itemdg.datagrid('getRows').length;
                    itemdg.datagrid('appendRow', {
                        Id: '',
                        Linage: rowCount + 1,
                        AccNo: currentRow.AccNo,
                        AccName: currentRow.AccName,
                        DCTypeNo: reverseDCTypeNo, // Reverse '借貸方向'
                        DCTypeNameC: reverseDCTypeName, // Update '借貸名稱' based on '借貸方向'
                        CurrencyNo: currentRow.CurrencyNo,
                        Rate1: currentRow.Rate1,
                        Money: currentRow.Money,
                        TargetId: currentRow.TargetId,
                        TargetType: currentRow.TargetType,
                        TargetNo: currentRow.TargetNo,
                        AccProfitId: currentRow.AccProfitId,
                        AccProfitNo: currentRow.AccProfitNo,
                        AccDeptId: currentRow.AccDeptId,
                        AccDeptNo: currentRow.AccDeptNo,
                        PayDeptId: currentRow.PayDeptId,
                        PayDeptNo: currentRow.PayDeptNo,
                        CheckType: currentRow.CheckType,
                        CheckId: currentRow.CheckId,
                        CheckNo: currentRow.CheckNo,
                        OffsetNo: currentRow.OffsetNo,
                        SourceDocId: currentRow.SourceDocId,
                        SourceSeqId: currentRow.SourceSeqId,
                        SourceDocSubTypeName: currentRow.SourceDocSubTypeName,
                        InitialProjectId: currentRow.InitialProjectId,
                        InitialDocSubType: currentRow.InitialDocSubType,
                        InitialDocId: currentRow.InitialDocId,
                        InitialDocSubTypeName: currentRow.InitialDocSubTypeName,
                        ActivityType: currentRow.ActivityType,
                        Remark: currentRow.Remark,
                        DCTypeNameC: currentRow.DCTypeNameC,
                        CurrencyNoNote: currentRow.CurrencyNoNote,
                        Money1: currentRow.Money1,
                        TargetAbbr: currentRow.TargetAbbr,
                        AccProfitName: currentRow.AccProfitName,
                        AccDeptName: currentRow.AccDeptName,
                        PayDeptName: currentRow.PayDeptName,
                        CaseBillNo: currentRow.CaseBillNo,
                        SourceNo: currentRow.SourceNo,
                        InitialNo: currentRow.InitialNo
                    });
                    var newIndex = itemdg.datagrid('getRows').length - 1;
                    itemdg.datagrid('selectRow', newIndex).datagrid('beginEdit', newIndex);
                    itemdgIndex = newIndex;
                    break;
                case 'remove':
                    if (itemdgIndex !== undefined) {
                        itemdg.datagrid('deleteRow', itemdgIndex);
                        rowCount = itemdg.datagrid('getRows').length;
                        for (var i = 0; i < rowCount; i++) {
                            itemdg.datagrid('updateRow', {
                                index: i,
                                row: {
                                    Linage: i + 1  // Start numbering from 1
                                }
                            });
                        }
                    } else {
                        $.messager.alert(msglang.Title3, '未選擇任何行刪除');
                    }
                    break;
                default:
                    break;
            }
        }

        // obj資料操作
        function objdata(objtype, action, callback) {
            switch (objtype.name) {
                case 'AccNo':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });
                        }
                    }
                    break;
                case 'CurrencyNo':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode3';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });

                        }
                    }
                    break;
                case 'AccDept':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode5';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });
                        }
                    }
                    break;
                case 'TargetNo0':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode4?type=15';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });
                        }
                    }
                    break;
                case 'TargetNo1':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode4?type=14';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });
                        }
                    }
                    break;
                case 'TargetNo2':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode4?type=12';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });
                        }
                    }
                    break;
                case 'TargetNo3':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode4?type=65';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });
                        }
                    }
                    break;
                case 'PayDept':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode6';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });
                        }
                    }
                    break;
                case 'TargetType':
                    if (action === 'clear') {
                        objtype.data = null;
                    } else if (action === 'read') {
                        if (objtype.data != null) {
                            if (callback) callback(objtype);
                        } else {
                            actionurl = defaultUrl + controllerurl + functionurl + 'GetEditTableCode2';
                            doajax("GET", actionurl, null, function (result) {
                                if (result.success) {
                                    objtype.data = result.data;
                                } else {
                                    $.messager.alert(msglang.Title2, msglang.MsgErrCode + result.code);
                                    objtype.data = null;
                                    if (result.code == 'C0003') {
                                        console.log("C0003: [AccNo] Not Found");
                                    }
                                    if (result.code == 'C0004') {
                                        console.log(result.err);
                                    }
                                }
                                if (callback) callback(objtype);
                            });
                        }
                    }
                    break;
                default:
                    break;
            }
        }

        // PageReload
        function pageReload(billno, msg) {
            var url = new URL(window.location.href);
            url.searchParams.set('billno', billno);
            url.searchParams.set('msg', msg);
            window.location.href = url.toString();
        }

        //
        function selectRow(billno) {
            var rows = maindg.datagrid('getRows');
            for (var i = 0; i < rows.length; i++) {
                if (rows[i].BillNo === billno) {
                    maindg.datagrid('selectRow', i);
                    return;
                }
            }
        }

        //#endregion

        //#region 格式化
        // 日期轉換
        function formatDate(dateString) {
            const regex = /\/Date\((\d+)\)\//;
            const match = dateString.match(regex);
            const timestamp = match ? parseInt(match[1], 10) : 0;
            const date = new Date(timestamp);

            const year = date.getFullYear();
            const month = ('0' + (date.getMonth() + 1)).slice(-2);
            const day = ('0' + date.getDate()).slice(-2);

            return `${year}/${month}/${day}`;
        }

        // itemdg欄位Function
        function formatTargetType(value) {
            switch (String(value)) {
                case '15':
                    return '廠商';
                case '14':
                    return '客戶';
                case '12':
                    return '員工';
                case '65':
                    return '銀行';
                default:
                    return value; // 若不在上述範圍內，則回傳原值
            }
        }

        // 新增Form
        function addForm() {
            //日期欄位
            $('.fomBillDate').datebox({
                required: true,
                formatter: function (date) {
                    var y = date.getFullYear();
                    var m = date.getMonth() + 1;
                    var d = date.getDate();
                    return y + '/' + (m < 10 ? '0' + m : m) + '/' + (d < 10 ? '0' + d : d);
                },
                parser: function (s) {
                    if (!s) return new Date();
                    var parts = s.split('/');
                    var y = parseInt(parts[0], 10);
                    var m = parseInt(parts[1], 10);
                    var d = parseInt(parts[2], 10);
                    return new Date(y, m - 1, d);
                }
            });
            //下拉選單_單據類別
            $('.fomDocSubType').combogrid({
                required: true,
                panelWidth: 355,
                panelHeight: 150,
                idField: 'DocSubType',
                textField: 'DocSubType',
                mode: 'remote',
                url: defaultUrl + controllerurl + functionurl + 'GetAddInfoCode',
                columns: [[
                    { field: 'DocSubType', title: '單據類別', width: 150 },
                    { field: 'DocSubTypeName', title: '單據類別名稱', width: 180 }
                ]],
                onSelect: function (index, row) {
                    $('.fomDocSubTypeName').textbox('setValue', row.DocSubTypeName);
                }
            });
            //下拉選單_公司編號
            $('.fomCompNo').combogrid({
                required: true,
                panelWidth: 355,
                panelHeight: 150,
                idField: 'CompId',
                textField: 'CompNo',
                mode: 'remote',
                url: defaultUrl + controllerurl + functionurl + 'GetAddInfoCode2',
                columns: [[
                    { field: 'CompNo', title: '公司編號', width: 150 },
                    { field: 'CompAbbr', title: '公司編號名稱', width: 180 }
                ]],
                onSelect: function (index, row) {
                    $('.fomCompAbbr').textbox('setValue', row.CompAbbr);
                }
            });
            //下拉選單_傳票類別
            $('.fomVoucherType').combogrid({
                required: true,
                panelWidth: 355,
                panelHeight: 150,
                idField: 'VoucherType',
                textField: 'VoucherType',
                mode: 'remote',
                url: defaultUrl + controllerurl + functionurl + 'GetAddInfoCode3',
                columns: [[
                    { field: 'VoucherType', title: '傳票類別編號', width: 150 },
                    { field: 'VoucherNameC', title: '類別中文名稱', width: 180 }
                ]],
                onSelect: function (index, row) {
                    $('.fomVoucherNameC').textbox('setValue', row.VoucherNameC);
                }
            });
            //下拉選單_幣別
            $('.fomCurrencyNo').combogrid({
                required: true,
                panelWidth: 157,
                panelHeight: 150,
                idField: 'CurrencyNo',
                textField: 'CurrencyNo',
                mode: 'remote',
                url: defaultUrl + controllerurl + functionurl + 'GetAddInfoCode4',
                columns: [[
                    { field: 'CurrencyNo', title: '幣別', width: 150 }
                ]],
                onSelect: function (index, row) {
                    $('.fomRate1').textbox('setValue', row.Rate);
                    $('.fomRate2').textbox('setValue', row.Rate);
                }
            });
            //預設欄位填值
            $('.fomEmpNo').textbox('setValue','@Model.EmpNo');
            $('.fomEmpNameC').textbox('setValue','@Model.EmpNameC');
            $('.fomDeptNo').textbox('setValue','@Model.DeptNo');
            $('.fomDeptName').textbox('setValue','@Model.DeptName');
            $('.fomCurrencySt').textbox('setValue','@Model.CurrencySt');
            //借貸欄位
            $('.colCurrencyD').textbox('setValue','@Model.CurrencySt');
            $('.colCurrencyC').textbox('setValue','@Model.CurrencySt');
            $('.colCurrency').textbox('setValue','@Model.CurrencySt');
        }
        //#endregion

        //#region 彈跳視窗
        function dlgEditAccNo() {
            objdata(objAccNo, 'read', function (data) {
                if (data.data) {
                    dlgdg1.datagrid('loadData', data.data);
                } else {
                    dlgdg1.datagrid('loadData', '');
                }
            });
            let winheight = $(window).height();
            let winwidth = $(window).width();
            $('#dlgEditAccNo').dialog({ height: winheight - 50, width: winwidth - 200, title: '會計科目' });
            $('#dlgEditAccNo').dialog('open').dialog('center');
        }
        function dlgEditTarget() {
            let editTargetType = itemdg.datagrid('getRows')[itemdgIndex].TargetType;
            switch (editTargetType) {
                case '15':
                    objdata(objTargetNo0, 'read', function (data) {
                        if (data.data) {
                            dlgdg30.datagrid('loadData', data.data);
                            dlgtabs.tabs('select', 0);
                        } else {
                            dlgdg30.datagrid('loadData', '');
                        }
                    });
                    break;
                case '14':
                    objdata(objTargetNo1, 'read', function (data) {
                        if (data.data) {
                            dlgdg31.datagrid('loadData', data.data);
                            dlgtabs.tabs('select', 1);
                        } else {
                            dlgdg31.datagrid('loadData', '');
                        }
                    });
                    break;
                case '12':
                    objdata(objTargetNo2, 'read', function (data) {
                        if (data.data) {
                            dlgdg32.datagrid('loadData', data.data);
                            dlgtabs.tabs('select', 2);
                        } else {
                            dlgdg32.datagrid('loadData', '');
                        }
                    });
                    break;
                case '65':
                    objdata(objTargetNo3, 'read', function (data) {
                        if (data.data) {
                            dlgdg33.datagrid('loadData', data.data);
                            dlgtabs.tabs('select', 3);
                        } else {
                            dlgdg33.datagrid('loadData', '');
                        }
                    });
                    break;
                default:
                    break;
            }
            let winheight = $(window).height();
            let winwidth = $(window).width();
            $('#dlgEditTargetNo').dialog({ height: winheight - 100, width: winwidth - 200, title: '對象編號' });
            $('#dlgEditTargetNo').dialog('open').dialog('center');
        }
        function dlgEditAccDept() {
            objdata(objAccDept, 'read', function (data) {
                if (data.data) {
                    dlgdg4.datagrid('loadData', data.data);
                } else {
                    dlgdg4.datagrid('loadData', '');
                }
            });
            let winheight = $(window).height();
            let winwidth = $(window).width();
            $('#dlgEditAccDept').dialog({ height: winheight - 100, width: winwidth - 200, title: '成本中心' });
            $('#dlgEditAccDept').dialog('open').dialog('center');
        }
        function dlgEditPayDept() {
            objdata(objPayDept, 'read', function (data) {
                if (data.data) {
                    dlgdg5.datagrid('loadData', data.data);
                } else {
                    dlgdg5.datagrid('loadData', '');
                }
            });
            let winheight = $(window).height();
            let winwidth = $(window).width();
            $('#dlgEditPayDept').dialog({ height: winheight - 100, width: winwidth - 200, title: '支付部門' });
            $('#dlgEditPayDept').dialog('open').dialog('center');
        }
        //#endregion
    </script>
    <script>
        // 監聽器
        // itemdg編輯_remark按下enter
        $(document).ready(function () {
            $(document).keydown(function (e) {
                if (e.key === 'Enter') {
                    if (actioncode == 'add' || actioncode == 'edit') {
                        rowCount = itemdg.datagrid('getRows').length;

                        // 先檢查 itemdg 是否被正確初始化
                        if (!itemdg) {
                            console.error('itemdg is not initialized');
                            return;
                        }

                        // 如果 itemdg 是空的，直接新增第一列
                        if (rowCount === 0) {
                            itemdg.datagrid('appendRow', {
                                Id: '',
                                Linage: 1,
                                AccNo: '',
                                AccName: '',
                                DCTypeNo: '',
                                CurrencyNo: (actioncode == 'add') ? $('.fomCurrencyNo').textbox('getValue') : $('.colCurrencyNo').textbox('getValue'),
                                CurrencySt: (actioncode == 'add') ? $('.fomCurrencySt').textbox('getValue') : $('.colCurrencySt').textbox('getValue'),
                                Rate1: (actioncode == 'add') ? $('.fomRate1').textbox('getValue') : $('.colRate1').textbox('getValue'),
                                Money: 0,
                                TargetId: '',
                                TargetType: '',
                                TargetNo: '',
                                AccProfitId: '',
                                AccProfitNo: '',
                                AccDeptId: '',
                                AccDeptNo: '',
                                PayDeptId: '',
                                PayDeptNo: '',
                                CheckType: '',
                                CheckId: '',
                                CheckNo: '',
                                OffsetNo: '',
                                SourceDocId: '',
                                SourceSeqId: '',
                                SourceDocSubTypeName: '',
                                InitialProjectId: '',
                                InitialDocSubType: '',
                                InitialDocId: '',
                                InitialDocSubTypeName: '',
                                ActivityType: '',
                                Remark: '',
                                DCTypeNameC: '',
                                CurrencyNoNote: '',
                                Money1: 0,
                                TargetAbbr: '',
                                AccProfitName: '',
                                AccDeptName: '',
                                PayDeptName: '',
                                CaseBillNo: '',
                                SourceNo: '',
                                InitialNo: ''
                            });
                            var newIndex = itemdg.datagrid('getRows').length - 1;
                            itemdg.datagrid('selectRow', newIndex).datagrid('beginEdit', newIndex);
                            itemdgIndex = newIndex;
                        } else {
                            if (itemdgIndex !== undefined) {
                                itemdg.datagrid('endEdit', itemdgIndex);
                            } else {
                                itemdg.datagrid('appendRow', {
                                    Id: '',
                                    Linage: rowCount + 1,
                                    AccNo: '',
                                    AccName: '',
                                    DCTypeNo: '',
                                    CurrencyNo: (actioncode == 'add') ? $('.fomCurrencyNo').textbox('getValue') : $('.colCurrencyNo').textbox('getValue'),
                                    CurrencySt: (actioncode == 'add') ? $('.fomCurrencySt').textbox('getValue') : $('.colCurrencySt').textbox('getValue'),
                                    Rate1: (actioncode == 'add') ? $('.fomRate1').textbox('getValue') : $('.colRate1').textbox('getValue'),
                                    Money: 0,
                                    TargetId: '',
                                    TargetType: '',
                                    TargetNo: '',
                                    AccProfitId: '',
                                    AccProfitNo: '',
                                    AccDeptId: '',
                                    AccDeptNo: '',
                                    PayDeptId: '',
                                    PayDeptNo: '',
                                    CheckType: '',
                                    CheckId: '',
                                    CheckNo: '',
                                    OffsetNo: '',
                                    SourceDocId: '',
                                    SourceSeqId: '',
                                    SourceDocSubTypeName: '',
                                    InitialProjectId: '',
                                    InitialDocSubType: '',
                                    InitialDocId: '',
                                    InitialDocSubTypeName: '',
                                    ActivityType: '',
                                    Remark: '',
                                    DCTypeNameC: '',
                                    CurrencyNoNote: '',
                                    Money1: 0,
                                    TargetAbbr: '',
                                    AccProfitName: '',
                                    AccDeptName: '',
                                    PayDeptName: '',
                                    CaseBillNo: '',
                                    SourceNo: '',
                                    InitialNo: ''
                                });
                                var newIndex = itemdg.datagrid('getRows').length - 1;
                                itemdg.datagrid('selectRow', newIndex).datagrid('beginEdit', newIndex);
                                itemdgIndex = newIndex;
                            }
                        }
                    }
                }
            });
        });

    </script>
    <script>
        $(document).ready(function () {
            /*$('#btnAdd').addClass('hidden-btn');*/
           /* $('#btnEdit').addClass('hidden-btn');*/
            /*$('#btnSave').addClass('hidden-btn');*/
            $('#btnDetail').addClass('hidden-btn');
            $('#btnRefresh').addClass('hidden-btn');
            /*$('#btnCancel').addClass('hidden-btn');*/
           /* $('#btnDelete').addClass('hidden-btn');*/

            $('#btnLock').hide();
            $('#btnCheck').hide();
            $('#btnClose').hide();
            $('#btnUnlock').hide();
            $('#btnReject').hide();

            let msg = '@ViewBag.Msg';
            let billno = '@ViewBag.BillNo';
            if (msg) {
                switch (msg) {
                    case 'Add':
                        $.messager.alert(msglang.Title3, msglang.MsgSes7 + billno);
                        break;
                    case 'Save':
                        $.messager.alert(msglang.Title3, msglang.MsgSes6 + billno);
                        break;
                    case 'Delete':
                        $.messager.alert(msglang.Title3, msglang.MsgSes8 + billno);
                        break;
                    default:
                        break;
                }
            }
        });
    </script>
}